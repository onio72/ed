<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerarios Educativos - IES El Majuelo (Completo)</title>
    
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style>
        /* ESTILOS GENERALES */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            overflow: hidden; 
        }

        /* CABECERA */
        #header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e0e0e0;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            flex-wrap: wrap;
        }

        .titles { max-width: 50%; }

        h1 { margin: 0; font-size: 24px; color: #2c3e50; }
        h2 { margin: 5px 0 0 0; font-size: 14px; color: #7f8c8d; font-weight: normal; }
        .version-tag { 
            display: inline-block; background: #e0f7fa; color: #006064; 
            padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-left: 10px;
        }

        /* LEYENDA */
        .legend { display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px; }
        .legend-item { display: flex; align-items: center; }
        .dot { width: 10px; height: 10px; border-radius: 3px; margin-right: 5px; border: 1px solid rgba(0,0,0,0.1); }

        .dot.eso { background-color: #E3F2FD; border-color: #2196F3; }
        .dot.bach { background-color: #E8F5E9; border-color: #4CAF50; }
        .dot.fp { background-color: #FFF3E0; border-color: #FF9800; }
        .dot.adultos { background-color: #F3E5F5; border-color: #9C27B0; }
        .dot.prueba { background-color: #F5F5F5; border-color: #9E9E9E; }
        .dot.pau { background-color: #FFEBEE; border-color: #EF5350; }
        .dot.salida { background-color: #ECEFF1; border-color: #607D8B; }
        .dot.externo { background-color: #f5f5f5; border-color: #999; border-style: dashed; }

        /* MAPA */
        #mynetwork { width: 100%; height: 100vh; background-color: #ffffff; }

        /* CONTROLES INFERIORES */
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        button {
            background: white; border: 1px solid #ccc; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-weight: bold; color: #555;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: all 0.2s;
        }
        button:hover { background: #f5f5f5; color: #000; }

        /* ESTILO DEL SELECTOR */
        select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
            color: #333;
            min-width: 200px;
            cursor: pointer;
        }

        /* PANEL DE CONFIGURACI√ìN DE ZONA */
        #zone-config {
            position: absolute;
            top: 90px;
            right: 20px;
            width: 200px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 15;
            font-size: 13px;
        }
        #zone-config h3 { margin: 0 0 10px 0; font-size: 14px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .input-group { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .input-group label { color: #666; }
        .input-group input { width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }
        
        @media (max-width: 768px) {
            #header { flex-direction: column; align-items: flex-start; }
            .titles { max-width: 100%; margin-bottom: 10px; }
            .legend { width: 100%; }
            #zone-config { top: auto; bottom: 80px; right: 20px; width: 180px; }
            .controls { flex-direction: column; align-items: stretch; left: 10px; right: 10px; bottom: 10px; }
        }
    </style>
</head>
<body>

    <div id="header">
        <div class="titles">
            <h1>Itinerarios Educativos ‚Äì IES El Majuelo <span class="version-tag">FILTRABLE</span></h1>
            <h2>Usa el selector inferior para ver solo un nivel y sus conexiones.</h2>
        </div>
        
        <div class="legend">
            <div class="legend-item"><div class="dot eso"></div> ESO</div>
            <div class="legend-item"><div class="dot bach"></div> Bachillerato</div>
            <div class="legend-item"><div class="dot fp"></div> FP</div>
            <div class="legend-item"><div class="dot adultos"></div> Adultos</div>
            <div class="legend-item"><div class="dot prueba"></div> Pruebas</div>
            <div class="legend-item"><div class="dot pau"></div> PAU</div>
            <div class="legend-item"><div class="dot externo"></div> Otro Centro</div>
        </div>
    </div>

    <!-- Panel para mover el rect√°ngulo -->
    <div id="zone-config">
        <h3>Zona IES El Majuelo</h3>
        <div class="input-group">
            <label>Posici√≥n X:</label>
            <input type="number" id="rectX" value="-480" onchange="updateZone()">
        </div>
        <div class="input-group">
            <label>Posici√≥n Y:</label>
            <input type="number" id="rectY" value="-330" onchange="updateZone()">
        </div>
        <div class="input-group">
            <label>Ancho:</label>
            <input type="number" id="rectW" value="790" onchange="updateZone()">
        </div>
        <div class="input-group">
            <label>Alto:</label>
            <input type="number" id="rectH" value="600" onchange="updateZone()">
        </div>
        <div style="font-size: 11px; color: #999; margin-top: 5px;">Ajusta el recuadro de la oferta interna.</div>
    </div>

    <div id="mynetwork"></div>

    <div class="controls">
        <!-- SELECTOR DE FILTRO -->
        <select id="focusSelect" onchange="filterGraph()">
            <option value="all">üëÅÔ∏è Ver Mapa Completo</option>
            <!-- Las opciones se llenan autom√°ticamente con JS -->
        </select>
        
        <button onclick="restorePositions()">Restaurar Nodos</button>
        <button onclick="fitGraph()">Centrar Mapa</button>
    </div>

    <script type="text/javascript">
        
        // --- VARIABLES DE LA ZONA (RECT√ÅNGULO) ---
        let zone = {
            x: -480,
            y: -330,
            w: 790,
            h: 600
        };

        // --- DATOS DE NODOS ---
        const nodesData = [
            // --- Nivel 0 ---
            { id: 1, label: 'E.S.O.\n(Educaci√≥n Secundaria Obligatoria)', group: 'eso', x: 0, y: -300 },

            // --- Nivel 1 ---
            { id: 5, label: 'ESA\n(Adultos)', group: 'adultos', x: -400, y: -250 }, 
            { id: 6, label: 'Prueba Libre\nESO', group: 'prueba', x: -400, y: -150 },
            { id: 3, label: 'F.P. B√°sica', group: 'fp', x: -100, y: -150 },

            // --- BACHILLERATO (Interno) ---
            { 
                id: 2, 
                label: 'Bachillerato\n(Ciencias y Humanidades)', 
                group: 'bach', 
                x: 200, 
                y: -100 
            },

            // --- EXTERNOS (Derecha) ---
            { 
                id: 14, label: 'Bachillerato ARTES\n(En otro centro)', group: 'externo', 
                x: 450, y: -100, shape: 'box', font: { color: '#666' }
            },
            { 
                id: 16, label: 'Grado Medio\n(Otros Centros)', group: 'externo', 
                x: 450, y: 50, shape: 'box', font: { color: '#666' }
            },
            { 
                id: 17, label: 'Grado Superior\n(Otros Centros)', group: 'externo', 
                x: 450, y: 200, shape: 'box', font: { color: '#666' }
            },

            // Bachillerato Adultos (Interno)
            { id: 13, label: 'Bachillerato\n(Adultos)', group: 'adultos', x: -400, y: -60 },

            // --- Nivel 2 ---
            // NUEVO NODO: Curso Espec√≠fico
            { id: 18, label: 'Curso Espec√≠fico\nAcceso GM', group: 'prueba', x: -400, y: 20 },
            
            { id: 10, label: 'Prueba Acceso\na Grado Medio', group: 'prueba', x: -400, y: 100 },
            
            { id: 4, label: 'Grado Medio\n(Ciclo Formativo)', group: 'fp', x: -50, y: 50 },

            // --- PAU (Nuevo Nodo Intermedio) ---
            { 
                id: 15, 
                label: 'PAU / EBAU\n(Selectividad)', 
                group: 'pau', 
                x: 250, 
                y: 200 
            },

            // --- Nivel 3 ---
            { id: 11, label: 'Prueba Acceso\na Grado Superior', group: 'prueba', x: -400, y: 200 },
            { id: 7, label: 'Grado Superior\n(Ciclo Formativo)', group: 'fp', x: 50, y: 200 },

            // --- Nivel 4 (Salidas) ---
            { id: 12, label: 'Acceso Universidad\nMayores 25', group: 'prueba', x: 250, y: 350 },
            { id: 9, label: 'MUNDO LABORAL\n(Empleo)', group: 'salida', x: -150, y: 350 },
            { id: 8, label: 'UNIVERSIDAD\n(Grado)', group: 'salida', x: 250, y: 450 },
        ];

        const edgesData = [
            // Desde ESO
            { from: 1, to: 2, label: 'T√≠tulo ESO' },
            { from: 1, to: 4, label: 'T√≠tulo ESO' },
            
            { 
                from: 1, 
                to: 3, 
                label: '15 a√±os + 3¬∫ ESO\n+ Consejo Orientador',
                title: 'Requisitos de Acceso a FP B√°sica:\n- Tener 15 a√±os cumplidos (o en el a√±o en curso).\n- Haber cursado 3¬∫ de ESO (excepcionalmente 2¬∫).\n- Consejo Orientador favorable del equipo docente.'
            },
            
            { from: 1, to: 5, label: '+18 a√±os' },
            { from: 1, to: 6, label: '+18 a√±os' },
            
            // CONEXIONES A EXTERNOS DESDE ESO
            { from: 1, to: 14, label: 'T√≠tulo ESO', dashes: true, color: { color: '#999'} },
            { from: 1, to: 16, label: 'T√≠tulo ESO', dashes: true, color: { color: '#999'} },

            // FPB y Adultos ESO
            { from: 3, to: 4, label: 'T√≠tulo' },
            { from: 3, to: 16, label: 'T√≠tulo', dashes: true, color: { color: '#999'} }, 

            { from: 5, to: 2, label: 'T√≠tulo ESO' }, 
            { from: 5, to: 13, label: 'T√≠tulo ESO' }, 
            { from: 5, to: 4, label: 'T√≠tulo ESO' },
            { from: 5, to: 16, label: 'T√≠tulo ESO', dashes: true, color: { color: '#999'} },

            { from: 6, to: 2, label: 'T√≠tulo obtenido' },
            { from: 6, to: 13, label: 'T√≠tulo obtenido' },
            { from: 6, to: 4, label: 'T√≠tulo obtenido' },

            // Pruebas Acceso y GM (Actualizado con d)
            { 
                from: 10, 
                to: 4, 
                label: 'Superar Prueba', 
                title: 'd) Haber superado una prueba de acceso a ciclos formativos de grado medio.' 
            },
            { from: 10, to: 16, label: 'Superar Prueba', dashes: true, color: { color: '#999'} },

            // Curso Espec√≠fico Acceso GM (Nuevo con c)
            {
                from: 18,
                to: 4,
                label: 'Superar Curso',
                title: 'c) Haber superado un curso de formaci√≥n espec√≠fico preparatorio para el acceso a ciclos formativos de grado medio en centros p√∫blicos o privados autorizados por la Administraci√≥n educativa.'
            },

            // Desde GM Interno
            { from: 4, to: 7, label: 'T√≠tulo T√©cnico' },
            { from: 4, to: 17, label: 'T√≠tulo T√©cnico', dashes: true, color: { color: '#999'} }, 
            { from: 4, to: 9, label: 'Inserci√≥n' },

            // Desde GM Externo
            { from: 16, to: 17, label: 'T√≠tulo T√©cnico', dashes: true, color: { color: '#999'} },
            { from: 16, to: 7, label: 'T√≠tulo T√©cnico', dashes: true, color: { color: '#999'} }, 

            // Bachillerato (Normal)
            { from: 2, to: 15, label: 'T√≠tulo Bachiller' }, 
            { from: 2, to: 7, label: 'T√≠tulo (Sin PAU)' },
            { from: 2, to: 17, label: 'T√≠tulo (Sin PAU)', dashes: true, color: { color: '#999'} },
            { from: 2, to: 9, label: '', dashes: true, color: {color:'#ccc'} },

            // Bachillerato (Adultos)
            { from: 13, to: 15, label: 'T√≠tulo Bachiller' }, 
            { from: 13, to: 7, label: 'T√≠tulo' },

            // Bachillerato Artes (Externo)
            { from: 14, to: 15, label: 'T√≠tulo Bachiller', dashes: true, color: { color: '#999'} }, 
            { from: 14, to: 17, label: 'T√≠tulo', dashes: true, color: { color: '#999'} },

            // PAU a Universidad
            { from: 15, to: 8, label: 'Nota Admisi√≥n' },

            // GS y Accesos
            { from: 11, to: 7, label: 'Prueba +19' },
            { from: 11, to: 17, label: 'Prueba +19', dashes: true, color: { color: '#999'} },

            { from: 7, to: 8, label: 'Nota Media' }, 
            { from: 7, to: 9, label: 'Inserci√≥n' },
            { from: 17, to: 8, label: 'Nota Media', dashes: true, color: { color: '#999'} }, 

            // Uni lateral
            { from: 12, to: 8, label: 'Prueba Acceso' }
        ];

        // Definici√≥n de grupos
        const groups = {
            eso: { color: { background: '#E3F2FD', border: '#2196F3' }, font: { color: '#0d47a1' } },
            bach: { color: { background: '#E8F5E9', border: '#4CAF50' }, font: { color: '#1b5e20' } },
            fp: { color: { background: '#FFF3E0', border: '#FF9800' }, font: { color: '#e65100' } },
            adultos: { color: { background: '#F3E5F5', border: '#9C27B0' }, font: { color: '#4a148c' } },
            prueba: { color: { background: '#F5F5F5', border: '#9E9E9E' }, font: { color: '#616161' } },
            salida: { color: { background: '#ECEFF1', border: '#607D8B' }, font: { color: '#37474f' } },
            pau: { color: { background: '#FFEBEE', border: '#EF5350' }, font: { color: '#B71C1C' } },
            externo: { 
                color: { background: '#fafafa', border: '#999999' }, 
                shapeProperties: { borderDashes: [5, 5] }, 
                font: { color: '#666' } 
            }
        };

        const container = document.getElementById('mynetwork');
        const nodes = new vis.DataSet(nodesData);
        const edges = new vis.DataSet(edgesData);
        const data = { nodes: nodes, edges: edges };

        const options = {
            nodes: {
                shape: 'box',
                margin: 10,
                borderWidth: 2,
                shadow: true,
                font: { size: 16, multi: true },
                widthConstraint: { maximum: 200 }
            },
            edges: {
                arrows: { to: { enabled: true, type: 'arrow' } },
                color: { color: '#546E7A' },
                font: { size: 11, align: 'horizontal', background: 'rgba(255, 255, 255, 0.9)', strokeWidth: 0 },
                smooth: { enabled: true, type: 'cubicBezier', roundness: 0.5 }
            },
            physics: { enabled: false }, // Est√°tico
            layout: { hierarchical: { enabled: false } }, // Posici√≥n manual
            interaction: { dragNodes: true, zoomView: true, dragView: true, hover: true }
        };

        const network = new vis.Network(container, data, options);

        // --- DIBUJADO DEL RECT√ÅNGULO DE FONDO ---
        network.on("beforeDrawing", function (ctx) {
            ctx.save();
            ctx.setLineDash([10, 10]);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#2196F3';
            ctx.fillStyle = 'rgba(33, 150, 243, 0.03)';

            if (ctx.roundRect) {
                ctx.beginPath();
                ctx.roundRect(zone.x, zone.y, zone.w, zone.h, 20);
                ctx.stroke();
                ctx.fill();
            } else {
                ctx.beginPath();
                ctx.rect(zone.x, zone.y, zone.w, zone.h);
                ctx.stroke();
                ctx.fill();
            }

            ctx.font = "bold 16px Arial";
            ctx.fillStyle = "#2196F3";
            ctx.textAlign = "left";
            ctx.fillText("Oferta Educativa IES El Majuelo", zone.x + 20, zone.y + 30);
            ctx.restore();
        });

        // --- FUNCIONALIDAD DEL PANEL ---
        function updateZone() {
            zone.x = parseInt(document.getElementById('rectX').value);
            zone.y = parseInt(document.getElementById('rectY').value);
            zone.w = parseInt(document.getElementById('rectW').value);
            zone.h = parseInt(document.getElementById('rectH').value);
            network.redraw();
        }

        // --- FUNCIONALIDAD DE FILTRADO (NUEVO) ---
        function populateSelector() {
            const selector = document.getElementById('focusSelect');
            // Ordenar nodos alfab√©ticamente para facilitar la b√∫squeda
            const sortedNodes = nodes.get().sort((a, b) => a.label.localeCompare(b.label));
            
            sortedNodes.forEach(node => {
                const option = document.createElement('option');
                option.value = node.id;
                // Limpiar saltos de l√≠nea para el texto del selector
                option.text = node.label.replace(/\n/g, " "); 
                selector.appendChild(option);
            });
        }

        function filterGraph() {
            const selectedValue = document.getElementById('focusSelect').value;

            if (selectedValue === 'all') {
                // Mostrar todos
                nodes.forEach(n => nodes.update({id: n.id, hidden: false}));
                edges.forEach(e => edges.update({id: e.id, hidden: false}));
            } else {
                const nodeId = parseInt(selectedValue);
                
                // Obtener conectados
                const connectedNodes = network.getConnectedNodes(nodeId);
                const connectedEdges = network.getConnectedEdges(nodeId);

                // Recorrer todos los nodos para ocultar/mostrar
                const allNodes = nodes.getIds();
                const nodeUpdates = allNodes.map(id => {
                    // Es visible si es el nodo seleccionado O es uno de sus conectados
                    const isVisible = (id === nodeId) || connectedNodes.includes(id);
                    return { id: id, hidden: !isVisible };
                });
                nodes.update(nodeUpdates);

                // Recorrer todas las aristas para ocultar/mostrar
                const allEdges = edges.getIds();
                const edgeUpdates = allEdges.map(id => {
                    // Es visible si est√° en la lista de conectados
                    const isVisible = connectedEdges.includes(id);
                    return { id: id, hidden: !isVisible };
                });
                edges.update(edgeUpdates);
            }
        }

        // Inicializar el selector cuando cargue
        populateSelector();

        network.once("afterDrawing", function() {
            network.fit({ animation: { duration: 1000, easingFunction: 'easeInOutQuad' } });
        });

        function fitGraph() {
            network.fit({ animation: { duration: 800 } });
        }

        function restorePositions() {
            nodesData.forEach(nodeData => {
                nodes.update({id: nodeData.id, x: nodeData.x, y: nodeData.y});
            });
            network.fit({ animation: { duration: 800 } });
            // Resetear filtro al restaurar
            document.getElementById('focusSelect').value = 'all';
            filterGraph();
        }

    </script>
</body>
</html>
