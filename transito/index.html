
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tránsito 2025-26. IES El Majuelo</title>
  <style>
    :root {
      --bg: #f6f4f1;
      --card: #ffffff;
      --ink: #1d1f23;
      --muted: #6b7280;
      --line: #e5e1dc;
      --accent: #1b5e57;
      --accent-2: #0f3d3a;
      --warning: #9a3412;
      --good: #0f766e;
      --bad: #b91c1c;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --radius: 16px;
      --radius-sm: 10px;
      --font-sans: "Sora", "Avenir Next", "Segoe UI", sans-serif;
      --font-serif: "Fraunces", "Georgia", serif;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font-sans);
      color: var(--ink);
      background: radial-gradient(1200px 800px at 20% 10%, #f1ede7 0%, #f6f4f1 50%, #f8f7f5 100%);
    }
    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px 24px 64px;
    }
    header {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 24px;
      align-items: center;
      margin-bottom: 24px;
    }
    body.center-active #mainHeader {
      display: none;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .brand img {
      width: 64px;
      height: 64px;
      object-fit: contain;
      border-radius: 8px;
      background: #fff;
      border: 1px solid var(--line);
      padding: 4px;
    }
    .logo-junta {
      width: 140px;
      height: auto;
      object-fit: contain;
    }
    .title {
      font-family: var(--font-serif);
      font-size: 32px;
      letter-spacing: 0.2px;
      margin: 0 0 6px;
    }
    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
    .privacy {
      background: #f1f5f2;
      border: 1px solid #d7e5dd;
      color: #1f3d33;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 12px;
      text-align: center;
    }

    .upload-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .tabs {
      display: inline-flex;
      gap: 8px;
      margin: 10px 0 20px;
      background: #eee9e2;
      padding: 6px;
      border-radius: 999px;
      flex-wrap: wrap;
    }
    .tab-btn {
      border: 0;
      background: transparent;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      color: #3b3f44;
    }
    .tab-btn.active {
      background: #ffffff;
      box-shadow: var(--shadow);
      color: var(--accent-2);
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .card h3 {
      margin: 0 0 6px;
      font-size: 15px;
    }
    .card p {
      margin: 0 0 12px;
      font-size: 12px;
      color: var(--muted);
    }
    .file-input {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    input[type="file"] {
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed #c7c2bc;
      background: #faf8f5;
    }
    .btn {
      border: 0;
      background: var(--accent);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.15s ease, background 0.15s ease;
    }
    .btn:hover { background: var(--accent-2); transform: translateY(-1px); }
    .btn-secondary {
      background: #efece7;
      color: #222;
      border: 1px solid var(--line);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 18px 0 24px;
    }
    .kpi {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      box-shadow: var(--shadow);
    }
    .kpi .label { font-size: 12px; color: var(--muted); }
    .kpi .value { font-size: 22px; font-weight: 700; margin-top: 4px; }
    .kpi .delta { font-size: 12px; margin-top: 2px; }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .filters label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    .filters input, .filters select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
    }
    .total-row {
      background: #f3efe9;
      font-weight: 700;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 820px;
    }
    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      font-size: 13px;
    }
    th {
      background: #f4f1ec;
      color: #2d2a26;
      cursor: pointer;
      position: sticky;
      top: 0;
    }
    tbody tr:hover { background: #faf7f2; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
    }
    .good { color: var(--good); }
    .bad { color: var(--bad); }

    .insights {
      margin: 20px 0;
      padding: 16px;
      border-radius: var(--radius);
      background: #f7f5f1;
      border: 1px solid var(--line);
    }
    .insights h3 { margin: 0 0 10px; font-size: 14px; }
    .insights ul { margin: 0; padding: 0; list-style: none; }
    .insights li {
      padding: 6px 0;
      font-size: 13px;
      border-bottom: 1px dashed #dedad4;
    }
    .insights li:last-child { border-bottom: none; }

    .dist-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 18px;
    }
    .fail-panel {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 18px;
    }
    .detail-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 18px;
    }
    .chart-stack {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .chart-stack canvas {
      height: 260px !important;
    }
    .chart-card { padding: 16px; }
    canvas { width: 100% !important; height: 320px !important; }

    .footer-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 16px;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 900px) {
      header { grid-template-columns: 1fr; }
      .dist-panel { grid-template-columns: 1fr; }
      .detail-panel { grid-template-columns: 1fr; }
      canvas { height: 280px !important; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600&family=Sora:wght@300;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app">
    <header id="mainHeader">
      <div class="brand">
        <img src="maju22.bmp" alt="IES El Majuelo" />
        <div>
          <h1 class="title">Tránsito 2025-26. IES El Majuelo</h1>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
        <img src="logojunta.png" alt="Junta de Andalucía" class="logo-junta" />
      </div>
    </header>

    <div class="tabs" id="tabsContainer">
      <button class="tab-btn active" data-tab="results">Resultados</button>
      <button class="tab-btn" data-tab="admin">Administrador</button>
    </div>

    <section class="tab-panel active" id="tab-results">
      <section class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Colegio</th>
              <th>Alumnos curso actual</th>
              <th>% sobre total actual</th>
              <th>Alumnos curso anterior</th>
              <th>% sobre total anterior</th>
              <th>Δ alumnos</th>
            </tr>
          </thead>
          <tbody id="distTableBody"></tbody>
        </table>
      </section>
      <section class="filters" style="margin-top: 10px;">
        <div>
          <label for="filterResidual">Ocultar colegios residuales (&lt;5 alumnos)</label>
          <select id="filterResidual">
            <option value="all">Mostrar todos</option>
            <option value="hide" selected>Ocultar &lt; 5</option>
          </select>
        </div>
      </section>

      <section class="dist-panel">
        <div class="card chart-card">
          <h3>Alumnado por colegio (Curso actual)</h3>
          <canvas id="distBarCurr"></canvas>
        </div>
        <div class="card chart-card">
          <h3>% alumnado (Curso actual)</h3>
          <canvas id="distPieCurr"></canvas>
        </div>
        <div class="card chart-card">
          <h3>Alumnado por colegio (Curso anterior)</h3>
          <canvas id="distBarPrev"></canvas>
        </div>
        <div class="card chart-card">
          <h3>% alumnado (Curso anterior)</h3>
          <canvas id="distPiePrev"></canvas>
        </div>
      </section>

      <section class="fail-panel">
        <section class="filters" style="margin-top: 0;">
          <div>
          <label for="filterTop4">Filtrar: solo 4 centros mayoritarios</label>
          <select id="filterTop4">
            <option value="all">Mostrar todos</option>
            <option value="top4" selected>Solo Top 4</option>
          </select>
        </div>
      </section>
        <div class="card">
          <h3>Suspensos por centro (datos absolutos)</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Centro</th>
                  <th>Curso</th>
                  <th>0</th>
                  <th>1-2</th>
                  <th>3-5</th>
                  <th>&gt;5</th>
                  <th>Media suspensos</th>
                  <th>Total alumnos</th>
                </tr>
              </thead>
              <tbody id="failAbsBody"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <h3>Suspensos por centro (% sobre total)</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Centro</th>
                  <th>Curso</th>
                  <th>0</th>
                  <th>1-2</th>
                  <th>3-5</th>
                  <th>&gt;5</th>
                </tr>
              </thead>
              <tbody id="failPctBody"></tbody>
            </table>
          </div>
        </div>
        <div class="card chart-card">
          <h3>Suspensos por centro (absolutos) — total</h3>
          <canvas id="failAbsTotalChart"></canvas>
        </div>
        <div class="card chart-card">
          <h3>Suspensos por centro (% sobre total) — total</h3>
          <canvas id="failPctTotalChart"></canvas>
        </div>
        <div class="card">
          <p style="margin:0;font-size:12px;color:#6b7280;">Nota: en los totales se contabilizan repetidores; en los datos desagregados por colegio no.</p>
        </div>
        <div class="card chart-card">
          <h3>Suspensos por centro (absolutos) — conjunto</h3>
          <canvas id="failAbsChart"></canvas>
        </div>
        <div class="card">
          <label for="failAbsSelect" style="font-size:12px;color:#6b7280;">Centro (Top 4)</label>
          <select id="failAbsSelect" style="margin-top:6px;"></select>
        </div>
        <div class="card chart-card">
          <h3>Suspensos por centro (absolutos) — detalle</h3>
          <canvas id="failAbsSingleChart"></canvas>
        </div>
        <div class="card chart-card">
          <h3>Suspensos por centro (% sobre total) — conjunto</h3>
          <canvas id="failPctChart"></canvas>
        </div>
        <div class="card">
          <label for="failPctSelect" style="font-size:12px;color:#6b7280;">Centro (Top 4)</label>
          <select id="failPctSelect" style="margin-top:6px;"></select>
        </div>
        <div class="card chart-card">
          <h3>Suspensos por centro (% sobre total) — detalle</h3>
          <canvas id="failPctSingleChart"></canvas>
        </div>
      </section>
    </section>

    <section class="tab-panel" id="tab-admin">
      <section class="upload-panel">
        <div class="card">
          <h3>Curso anterior</h3>
          <p>Carga el Excel del curso pasado.</p>
          <div class="file-input">
            <input type="file" id="filePrev" accept=".xlsx,.xls,.csv" />
          </div>
        </div>
        <div class="card">
          <h3>Curso actual</h3>
          <p>Carga el Excel del curso actual.</p>
          <div class="file-input">
            <input type="file" id="fileCurr" accept=".xlsx,.xls,.csv" />
          </div>
        </div>
        <div class="card">
          <h3>Acciones</h3>
          <p>Procesa y genera el dashboard.</p>
          <div class="file-input">
            <button class="btn" id="btnProcess">Procesar datos</button>
            <button class="btn btn-secondary" id="btnExportCSV">Exportar CSV</button>
            <button class="btn btn-secondary" id="btnReport">Generar informe para claustro</button>
            <div class="status" id="status">Esperando archivos.</div>
          </div>
        </div>
      </section>
    </section>

    <section id="centerPanels"></section>
  </div>

  <script>
    // ============================
    // Utilidades base y parsing
    // ============================
    const $ = (id) => document.getElementById(id);
    const valueOr = (id, fallback) => {
      const el = $(id);
      return el ? el.value : fallback;
    };

    const state = {
      prevRows: [],
      currRows: [],
      prevRowsAll: [],
      currRowsAll: [],
      prevAgg: new Map(),
      currAgg: new Map(),
      subjects: [],
      merged: [],
      top4: [],
      failBins: { prev: new Map(), curr: new Map(), totalPrev: null, totalCurr: null },
      charts: {
        distBarCurr: null,
        distPieCurr: null,
        distBarPrev: null,
        distPiePrev: null,
        failAbs: null,
        failPct: null,
        failAbsSingle: null,
        failPctSingle: null,
        failAbsTotal: null,
        failPctTotal: null
      }
    };

    // Estética global de gráficos
    Chart.defaults.font.family = "Sora, Avenir Next, Segoe UI, sans-serif";
    Chart.defaults.color = "#1f2937";
    Chart.defaults.plugins.legend.labels.boxWidth = 14;
    Chart.defaults.plugins.legend.labels.padding = 12;
    const tabsContainer = $("tabsContainer");

    const COLUMN_SYNONYMS = {
      student: ["alumno", "alumna", "estudiante", "student"],
      school: ["centro", "centro de procedencia", "colegio", "procedencia", "school", "origin"],
      average: ["media", "nota media", "nota", "calificacion", "promedio"],
      fails: ["suspensos", "suspenso", "fails", "fallos"],
      bilingual: ["bilingue", "bilingüe"]
    };

    function normalizeHeader(text) {
      return String(text || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ")
        .replace(/[\u0300-\u036f]/g, "");
    }

    function guessColumn(headers, synonyms) {
      for (const h of headers) {
        const nh = normalizeHeader(h);
        if (!nh || nh.includes("unnamed") || nh.includes("total")) continue;
        if (synonyms.some(s => nh.includes(normalizeHeader(s)))) return h;
      }
      return null;
    }

    function detectSubjectColumns(headers, reserved) {
      const subjects = [];
      for (const h of headers) {
        const nh = normalizeHeader(h);
        if (!nh || nh.includes("unnamed") || nh.includes("total")) continue;
        if (reserved.has(h)) continue;
        // Detect subject-like columns: exclude binary or metadata
        if (/biling/i.test(nh) || /grupo|curso|fecha|observ/.test(nh)) continue;
        subjects.push(h);
      }
      return subjects;
    }

    function toNumber(value) {
      if (value === null || value === undefined || value === "") return null;
      if (typeof value === "number") return isFinite(value) ? value : null;
      const cleaned = String(value).replace(/,/g, ".").replace(/[^0-9.-]/g, "");
      const n = parseFloat(cleaned);
      return isFinite(n) ? n : null;
    }

    function readExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });
            resolve(rows);
          } catch (err) { reject(err); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    // ============================
    // Limpieza y normalización
    // ============================
    function cleanRows(rawRows, options = { excludeRepetidor: true }) {
      if (!rawRows || !rawRows.length) return { rows: [], subjects: [] };
      const headers = Object.keys(rawRows[0]);
      const schoolCol = guessColumn(headers, COLUMN_SYNONYMS.school);
      const avgCol = guessColumn(headers, COLUMN_SYNONYMS.average);
      const failCol = guessColumn(headers, COLUMN_SYNONYMS.fails);

      const reserved = new Set([schoolCol, avgCol, failCol].filter(Boolean));
      const subjects = detectSubjectColumns(headers, reserved);

      const rows = rawRows
        .filter(r => r && Object.values(r).some(v => v !== null && v !== ""))
        .map(r => {
          const school = (r[schoolCol] || "Sin especificar").toString().trim();
          const avg = toNumber(r[avgCol]);
          const fails = toNumber(r[failCol]);
          const subjectScores = {};
          subjects.forEach(s => {
            const v = toNumber(r[s]);
            if (v !== null) subjectScores[s] = v;
          });
          return { school, avg, fails, subjectScores };
        })
        .filter(r => {
          const schoolLower = r.school ? r.school.toLowerCase() : "";
          if (!schoolLower) return false;
          if (schoolLower === "total") return false;
          // Excluir alumnado marcado como repetidor en el campo colegio
          if (options.excludeRepetidor && schoolLower === "repetidor") return false;
          return true;
        });

      return { rows, subjects };
    }

    // ============================
    // Métricas y agregación
    // ============================
    function mean(values) {
      if (!values.length) return null;
      return values.reduce((a, b) => a + b, 0) / values.length;
    }

    function median(values) {
      if (!values.length) return null;
      const sorted = [...values].sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
    }

    function stddev(values) {
      if (values.length < 2) return null;
      const m = mean(values);
      const variance = mean(values.map(v => (v - m) ** 2));
      return Math.sqrt(variance);
    }

    function aggregateBySchool(rows, subjects) {
      const map = new Map();
      rows.forEach(r => {
        if (!map.has(r.school)) {
          map.set(r.school, {
            school: r.school,
            students: 0,
            averages: [],
            fails: [],
            subjectScores: {}
          });
        }
        const entry = map.get(r.school);
        entry.students += 1;
        if (r.avg !== null) entry.averages.push(r.avg);
        if (r.fails !== null) entry.fails.push(r.fails);
        subjects.forEach(s => {
          if (!entry.subjectScores[s]) entry.subjectScores[s] = [];
          if (r.subjectScores[s] !== undefined) entry.subjectScores[s].push(r.subjectScores[s]);
        });
      });

      for (const entry of map.values()) {
        entry.mean = mean(entry.averages);
        entry.median = median(entry.averages);
        entry.stddev = stddev(entry.averages);
        entry.failPct = entry.fails.length ? (entry.fails.filter(f => f > 0).length / entry.fails.length) * 100 : null;
        entry.failMean = entry.fails.length ? mean(entry.fails) : null;
        entry.subjectMeans = {};
        subjects.forEach(s => {
          entry.subjectMeans[s] = mean(entry.subjectScores[s] || []);
        });
      }

      return map;
    }

    function countFailsForRow(row, subjects) {
      if (!subjects.length) return 0;
      let count = 0;
      subjects.forEach(s => {
        const v = row.subjectScores[s];
        if (v !== undefined && v !== null && v < 5) count += 1;
      });
      return count;
    }

    function aggregateFailBins(rows, subjects) {
      const map = new Map();
      rows.forEach(r => {
        if (!map.has(r.school)) {
          map.set(r.school, { school: r.school, total: 0, sumFails: 0, b0: 0, b12: 0, b35: 0, b5p: 0 });
        }
        const entry = map.get(r.school);
        const fails = countFailsForRow(r, subjects);
        entry.total += 1;
        entry.sumFails += fails;
        if (fails === 0) entry.b0 += 1;
        else if (fails <= 2) entry.b12 += 1;
        else if (fails <= 5) entry.b35 += 1;
        else entry.b5p += 1;
      });
      return map;
    }

    function aggregateFailTotals(rows, subjects) {
      const total = { total: 0, sumFails: 0, b0: 0, b12: 0, b35: 0, b5p: 0 };
      rows.forEach(r => {
        const fails = countFailsForRow(r, subjects);
        total.total += 1;
        total.sumFails += fails;
        if (fails === 0) total.b0 += 1;
        else if (fails <= 2) total.b12 += 1;
        else if (fails <= 5) total.b35 += 1;
        else total.b5p += 1;
      });
      return total;
    }

    function mergeYearData(prevMap, currMap, subjects) {
      const schools = new Set([...prevMap.keys(), ...currMap.keys()]);
      const merged = [];
      schools.forEach(school => {
        const prev = prevMap.get(school) || {};
        const curr = currMap.get(school) || {};
        const prevMean = prev.mean ?? null;
        const currMean = curr.mean ?? null;
        const delta = (currMean !== null && prevMean !== null) ? currMean - prevMean : null;
        const deltaPct = (delta !== null && prevMean) ? (delta / prevMean) * 100 : null;
        const failPct = curr.failPct ?? null;
        merged.push({
          school,
          students: curr.students ?? prev.students ?? 0,
          prevMean,
          currMean,
          delta,
          deltaPct,
          failPct,
          prev,
          curr,
          subjects
        });
      });
      return merged;
    }

    // ============================
    // Render UI
    // ============================
    function format(value, decimals = 2) {
      if (value === null || value === undefined || isNaN(value)) return "—";
      return Number(value).toFixed(decimals);
    }

    function renderDistributionTable(data) {
      const body = $("distTableBody");
      body.innerHTML = "";
      if (!data.length) return;

      const totalCurr = data.reduce((acc, d) => acc + (d.curr?.students || 0), 0);
      const totalPrev = data.reduce((acc, d) => acc + (d.prev?.students || 0), 0);

      const rows = [...data].sort((a, b) => (b.curr?.students || 0) - (a.curr?.students || 0));
      rows.forEach(d => {
        const currStudents = d.curr?.students || 0;
        const prevStudents = d.prev?.students || 0;
        const currPct = totalCurr ? (currStudents / totalCurr) * 100 : null;
        const prevPct = totalPrev ? (prevStudents / totalPrev) * 100 : null;
        const deltaAbs = currStudents - prevStudents;
        const deltaClass = deltaAbs >= 0 ? "good" : "bad";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.school}</td>
          <td>${currStudents}</td>
          <td>${format(currPct, 1)}%</td>
          <td>${prevStudents}</td>
          <td>${format(prevPct, 1)}%</td>
          <td class="${deltaClass}">${deltaAbs}</td>
        `;
        body.appendChild(tr);
      });
    }

    function renderFailTables(schools = null) {
      const absBody = $("failAbsBody");
      const pctBody = $("failPctBody");
      absBody.innerHTML = "";
      pctBody.innerHTML = "";

      const totalRows = [
        { school: "TOTAL 1º (incluye repetidores)", course: "Actual", data: state.failBins.totalCurr },
        { school: "TOTAL 1º (incluye repetidores)", course: "Anterior", data: state.failBins.totalPrev }
      ];
      totalRows.forEach(r => {
        if (!r.data) return;
        const { b0, b12, b35, b5p, total, sumFails } = r.data;
        const meanFails = total ? (sumFails / total) : 0;
        const trAbs = document.createElement("tr");
        trAbs.className = "total-row";
        trAbs.innerHTML = `
          <td><strong>${r.school}</strong></td>
          <td><strong>${r.course}</strong></td>
          <td><strong>${b0}</strong></td>
          <td><strong>${b12}</strong></td>
          <td><strong>${b35}</strong></td>
          <td><strong>${b5p}</strong></td>
          <td><strong>${format(meanFails, 2)}</strong></td>
          <td><strong>${total}</strong></td>
        `;
        absBody.appendChild(trAbs);

        const pct = (v) => total ? (v / total) * 100 : 0;
        const trPct = document.createElement("tr");
        trPct.className = "total-row";
        trPct.innerHTML = `
          <td><strong>${r.school}</strong></td>
          <td><strong>${r.course}</strong></td>
          <td><strong>${format(pct(b0), 1)}%</strong></td>
          <td><strong>${format(pct(b12), 1)}%</strong></td>
          <td><strong>${format(pct(b35), 1)}%</strong></td>
          <td><strong>${format(pct(b5p), 1)}%</strong></td>
        `;
        pctBody.appendChild(trPct);
      });

      const allSchools = Array.from(new Set([
        ...state.failBins.curr.keys(),
        ...state.failBins.prev.keys()
      ])).sort();

      const visibleSchools = schools ? allSchools.filter(s => schools.includes(s)) : allSchools;

      const rows = [];
      visibleSchools.forEach(school => {
        const curr = state.failBins.curr.get(school);
        const prev = state.failBins.prev.get(school);
        if (curr) rows.push({ school, course: "Actual", data: curr });
        if (prev) rows.push({ school, course: "Anterior", data: prev });
      });

      rows.forEach(r => {
        const { b0, b12, b35, b5p, total, sumFails } = r.data;
        const meanFails = total ? (sumFails / total) : 0;
        const trAbs = document.createElement("tr");
        trAbs.innerHTML = `
          <td>${r.school}</td>
          <td>${r.course}</td>
          <td>${b0}</td>
          <td>${b12}</td>
          <td>${b35}</td>
          <td>${b5p}</td>
          <td>${format(meanFails, 2)}</td>
          <td>${total}</td>
        `;
        absBody.appendChild(trAbs);

        const pct = (v) => total ? (v / total) * 100 : 0;
        const trPct = document.createElement("tr");
        trPct.innerHTML = `
          <td>${r.school}</td>
          <td>${r.course}</td>
          <td>${format(pct(b0), 1)}%</td>
          <td>${format(pct(b12), 1)}%</td>
          <td>${format(pct(b35), 1)}%</td>
          <td>${format(pct(b5p), 1)}%</td>
        `;
        pctBody.appendChild(trPct);
      });
    }

    function updateTop4Selectors() {
      const absSelect = $("failAbsSelect");
      const pctSelect = $("failPctSelect");
      if (!absSelect || !pctSelect) return;

      absSelect.innerHTML = "";
      pctSelect.innerHTML = "";
      state.top4.forEach(s => {
        const opt1 = document.createElement("option");
        opt1.value = s;
        opt1.textContent = s;
        absSelect.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = s;
        opt2.textContent = s;
        pctSelect.appendChild(opt2);
      });
    }

    function renderFailSingleCharts(school, absId = "failAbsSingleChart", pctId = "failPctSingleChart") {
      if (!school) return;
      const bins = [
        { key: "b0", label: "0", color: "#9CCEF4", border: "#5FA8E4" },
        { key: "b12", label: "1-2", color: "#B7E4C7", border: "#7BCFA7" },
        { key: "b35", label: "3-5", color: "#FFD6A5", border: "#FFB570" },
        { key: "b5p", label: ">5", color: "#E7C6FF", border: "#C9A5F3" }
      ];
      const labels = bins.map(b => b.label);
      const curr = state.failBins.curr.get(school) || { total: 0 };
      const prev = state.failBins.prev.get(school) || { total: 0 };

      const currAbs = bins.map(b => curr[b.key] || 0);
      const prevAbs = bins.map(b => prev[b.key] || 0);
      const currPct = bins.map(b => curr.total ? ((curr[b.key] || 0) / curr.total) * 100 : 0);
      const prevPct = bins.map(b => prev.total ? ((prev[b.key] || 0) / prev.total) * 100 : 0);

      if (absId === "failAbsSingleChart" && state.charts.failAbsSingle) state.charts.failAbsSingle.destroy();
      if (pctId === "failPctSingleChart" && state.charts.failPctSingle) state.charts.failPctSingle.destroy();

      const absChart = new Chart($(absId).getContext("2d"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Actual", data: currAbs, backgroundColor: "#BFD7EA", borderColor: "#5FA8E4", borderWidth: 1, borderRadius: 8 },
            { label: "Anterior", data: prevAbs, backgroundColor: "#E7C6FF", borderColor: "#C9A5F3", borderWidth: 1, borderRadius: 8 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom", labels: { boxWidth: 12, font: { size: 11, weight: "500" } } } },
          scales: {
            x: { ticks: { color: "#475569" } },
            y: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.06)" }, ticks: { color: "#475569" } }
          }
        }
      });

      const pctChart = new Chart($(pctId).getContext("2d"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Actual", data: currPct, backgroundColor: "#BFD7EA", borderColor: "#5FA8E4", borderWidth: 1, borderRadius: 8 },
            { label: "Anterior", data: prevPct, backgroundColor: "#E7C6FF", borderColor: "#C9A5F3", borderWidth: 1, borderRadius: 8 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom", labels: { boxWidth: 12, font: { size: 11, weight: "500" } } } },
          scales: {
            x: { ticks: { color: "#475569" } },
            y: { beginAtZero: true, max: 100, grid: { color: "rgba(0,0,0,0.06)" }, ticks: { color: "#475569", callback: v => `${v}%` } }
          }
        }
      });

      if (absId === "failAbsSingleChart") state.charts.failAbsSingle = absChart;
      if (pctId === "failPctSingleChart") state.charts.failPctSingle = pctChart;
    }

    function renderCenterTabs() {
      const panels = $("centerPanels");
      panels.innerHTML = "";
      // Remove existing center tabs
      tabsContainer.querySelectorAll(".center-tab").forEach(btn => btn.remove());

      state.top4.forEach((school, idx) => {
        const tabId = `center-${idx}`;
        const schoolName = `C.E.I.P. ${school}`;
        const btn = document.createElement("button");
        btn.className = "tab-btn center-tab";
        btn.dataset.tab = tabId;
        btn.textContent = schoolName;
        tabsContainer.appendChild(btn);

        const panel = document.createElement("section");
        panel.className = "tab-panel";
        panel.id = `tab-${tabId}`;
        panel.innerHTML = `
          <header>
            <div class="brand">
              <img src="maju22.bmp" alt="IES El Majuelo" />
              <div>
                <h1 class="title">Tránsito 2025-26. IES El Majuelo</h1>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
              <img src="logojunta.png" alt="Junta de Andalucía" class="logo-junta" />
            </div>
          </header>
          <div class="card" style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
              <div>
                <h3 style="margin:0 0 4px;">${schoolName}</h3>
                <p class="subtitle">Resumen de suspensos por curso académico.</p>
              </div>
              <button class="btn btn-secondary" data-export="${tabId}">Exportar PDF</button>
            </div>
          </div>
          <div class="card">
            <h3>Suspensos (datos absolutos)</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Curso</th>
                    <th>0</th>
                    <th>1-2</th>
                    <th>3-5</th>
                    <th>&gt;5</th>
                    <th>Media suspensos</th>
                    <th>Total alumnos</th>
                  </tr>
                </thead>
                <tbody id="abs-${tabId}"></tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <h3>Suspensos (% sobre total)</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Curso</th>
                    <th>0</th>
                    <th>1-2</th>
                    <th>3-5</th>
                    <th>&gt;5</th>
                  </tr>
                </thead>
                <tbody id="pct-${tabId}"></tbody>
              </table>
            </div>
          </div>
          <div class="dist-panel export-charts">
            <div class="card chart-card">
              <h3>Suspensos (absolutos)</h3>
              <canvas id="absChart-${tabId}"></canvas>
            </div>
            <div class="card chart-card">
              <h3>Suspensos (% sobre total)</h3>
              <canvas id="pctChart-${tabId}"></canvas>
            </div>
          </div>
        `;
        panels.appendChild(panel);

        const renderAbsRow = (label, data) => {
          const total = data.total || 0;
          const meanFails = total ? (data.sumFails / total) : 0;
          const isTotal = label.toLowerCase().includes("total");
          return `
            <tr class="${isTotal ? "total-row" : ""}">
              <td>${label}</td>
              <td>${data.b0}</td>
              <td>${data.b12}</td>
              <td>${data.b35}</td>
              <td>${data.b5p}</td>
              <td>${format(meanFails, 2)}</td>
              <td>${total}</td>
            </tr>
          `;
        };
        const renderPctRow = (label, data) => {
          const total = data.total || 0;
          const pct = (v) => total ? (v / total) * 100 : 0;
          const isTotal = label.toLowerCase().includes("total");
          return `
            <tr class="${isTotal ? "total-row" : ""}">
              <td>${label}</td>
              <td>${format(pct(data.b0), 1)}%</td>
              <td>${format(pct(data.b12), 1)}%</td>
              <td>${format(pct(data.b35), 1)}%</td>
              <td>${format(pct(data.b5p), 1)}%</td>
            </tr>
          `;
        };

        const curr = state.failBins.curr.get(school) || { total: 0, sumFails: 0, b0: 0, b12: 0, b35: 0, b5p: 0 };
        const prev = state.failBins.prev.get(school) || { total: 0, sumFails: 0, b0: 0, b12: 0, b35: 0, b5p: 0 };
        const totalCurr = state.failBins.totalCurr || { total: 0, sumFails: 0, b0: 0, b12: 0, b35: 0, b5p: 0 };
        const totalPrev = state.failBins.totalPrev || { total: 0, sumFails: 0, b0: 0, b12: 0, b35: 0, b5p: 0 };

        const absBody = $(`abs-${tabId}`);
        const pctBody = $(`pct-${tabId}`);
        absBody.innerHTML = [
          renderAbsRow("Actual (centro)", curr),
          renderAbsRow("Anterior (centro)", prev),
          renderAbsRow("Total 1º (actual)", totalCurr),
          renderAbsRow("Total 1º (anterior)", totalPrev)
        ].join("");
        pctBody.innerHTML = [
          renderPctRow("Actual (centro)", curr),
          renderPctRow("Anterior (centro)", prev),
          renderPctRow("Total 1º (actual)", totalCurr),
          renderPctRow("Total 1º (anterior)", totalPrev)
        ].join("");

        renderFailSingleCharts(school, `absChart-${tabId}`, `pctChart-${tabId}`);
      });
    }

    function exportTabToPdf(tabId) {
      const panel = $(`tab-${tabId}`);
      if (!panel) return;
      const clone = panel.cloneNode(true);
      // Replace canvases with images
      const originals = panel.querySelectorAll("canvas");
      const clones = clone.querySelectorAll("canvas");
      clones.forEach((c, i) => {
        const orig = originals[i];
        if (!orig) return;
        const img = document.createElement("img");
        img.src = orig.toDataURL("image/png");
        img.style.width = "100%";
        img.style.height = "auto";
        c.replaceWith(img);
      });
      const win = window.open("", "_blank");
      const styles = document.querySelector("style").innerHTML;
      const printStyles = `
        @media print {
          .card { box-shadow: none !important; }
          canvas, img { max-height: 220px; }
          .chart-card { padding: 12px; }
          .dist-panel { grid-template-columns: 1fr 1fr; }
          .export-charts { break-before: page; page-break-before: always; }
        }
        img { max-width: 100%; height: auto; display: block; }
      `;
      win.document.write(`
        <html>
          <head>
            <title>Informe ${tabId}</title>
            <style>${styles}\n${printStyles}</style>
          </head>
          <body>
            <div class="app">${clone.innerHTML}</div>
          </body>
        </html>
      `);
      win.document.close();
      const imgs = win.document.images;
      if (!imgs.length) {
        win.focus();
        win.print();
        return;
      }
      let loaded = 0;
      Array.from(imgs).forEach(img => {
        img.onload = () => {
          loaded += 1;
          if (loaded === imgs.length) {
            win.focus();
            win.print();
          }
        };
        img.onerror = () => {
          loaded += 1;
          if (loaded === imgs.length) {
            win.focus();
            win.print();
          }
        };
      });
    }

    function renderFailTotalCharts() {
      const bins = [
        { key: "b0", label: "0", color: "#9CCEF4", border: "#5FA8E4" },
        { key: "b12", label: "1-2", color: "#B7E4C7", border: "#7BCFA7" },
        { key: "b35", label: "3-5", color: "#FFD6A5", border: "#FFB570" },
        { key: "b5p", label: ">5", color: "#E7C6FF", border: "#C9A5F3" }
      ];
      const labels = bins.map(b => b.label);
      const curr = state.failBins.totalCurr || { total: 0 };
      const prev = state.failBins.totalPrev || { total: 0 };

      const currAbs = bins.map(b => curr[b.key] || 0);
      const prevAbs = bins.map(b => prev[b.key] || 0);
      const currPct = bins.map(b => curr.total ? ((curr[b.key] || 0) / curr.total) * 100 : 0);
      const prevPct = bins.map(b => prev.total ? ((prev[b.key] || 0) / prev.total) * 100 : 0);

      if (state.charts.failAbsTotal) state.charts.failAbsTotal.destroy();
      if (state.charts.failPctTotal) state.charts.failPctTotal.destroy();

      state.charts.failAbsTotal = new Chart($("failAbsTotalChart").getContext("2d"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Actual", data: currAbs, backgroundColor: "#BFD7EA", borderColor: "#5FA8E4", borderWidth: 1, borderRadius: 8 },
            { label: "Anterior", data: prevAbs, backgroundColor: "#E7C6FF", borderColor: "#C9A5F3", borderWidth: 1, borderRadius: 8 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom", labels: { boxWidth: 12, font: { size: 11, weight: "500" } } } },
          scales: {
            x: { ticks: { color: "#475569" } },
            y: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.06)" }, ticks: { color: "#475569" } }
          }
        }
      });

      state.charts.failPctTotal = new Chart($("failPctTotalChart").getContext("2d"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Actual", data: currPct, backgroundColor: "#BFD7EA", borderColor: "#5FA8E4", borderWidth: 1, borderRadius: 8 },
            { label: "Anterior", data: prevPct, backgroundColor: "#E7C6FF", borderColor: "#C9A5F3", borderWidth: 1, borderRadius: 8 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom", labels: { boxWidth: 12, font: { size: 11, weight: "500" } } } },
          scales: {
            x: { ticks: { color: "#475569" } },
            y: { beginAtZero: true, max: 100, grid: { color: "rgba(0,0,0,0.06)" }, ticks: { color: "#475569", callback: v => `${v}%` } }
          }
        }
      });
    }

    function renderFailCharts(schools = null) {
      const allSchools = Array.from(new Set([
        ...state.failBins.curr.keys(),
        ...state.failBins.prev.keys()
      ])).sort();
      let visibleSchools = schools ? allSchools.filter(s => schools.includes(s)) : allSchools;
      if (!visibleSchools.length) visibleSchools = allSchools;

      const bins = [
        { key: "b0", label: "0", color: "#9CCEF4", border: "#5FA8E4" },
        { key: "b12", label: "1-2", color: "#B7E4C7", border: "#7BCFA7" },
        { key: "b35", label: "3-5", color: "#FFD6A5", border: "#FFB570" },
        { key: "b5p", label: ">5", color: "#E7C6FF", border: "#C9A5F3" }
      ];

      const buildDatasets = (courseKey, stackName, percent = false, labels = []) => {
        return bins.map(b => ({
          label: `${b.label} (${stackName})`,
          data: labels.map(s => {
            const entry = state.failBins[courseKey].get(s);
            if (!entry) return 0;
            const value = entry[b.key] || 0;
            if (!percent) return value;
            return entry.total ? (value / entry.total) * 100 : 0;
          }),
          backgroundColor: b.color,
          borderColor: b.border,
          borderWidth: 1,
          borderRadius: 8,
          stack: stackName
        }));
      };

      const absDatasets = [
        ...buildDatasets("curr", "Actual", false, visibleSchools),
        ...buildDatasets("prev", "Anterior", false, visibleSchools)
      ];
      const pctDatasets = [
        ...buildDatasets("curr", "Actual", true, visibleSchools),
        ...buildDatasets("prev", "Anterior", true, visibleSchools)
      ];

      if (state.charts.failAbs) state.charts.failAbs.destroy();
      if (state.charts.failPct) state.charts.failPct.destroy();

      state.charts.failAbs = new Chart($("failAbsChart").getContext("2d"), {
        type: "bar",
        data: { labels: visibleSchools, datasets: absDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom", labels: { boxWidth: 12, font: { size: 11, weight: "500" } } }
          },
          scales: {
            x: { stacked: true, ticks: { color: "#475569", autoSkip: false, maxRotation: 30 } },
            y: { stacked: true, beginAtZero: true, grid: { color: "rgba(0,0,0,0.06)" }, ticks: { color: "#475569" } }
          }
        }
      });

      state.charts.failPct = new Chart($("failPctChart").getContext("2d"), {
        type: "bar",
        data: { labels: visibleSchools, datasets: pctDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom", labels: { boxWidth: 12, font: { size: 11, weight: "500" } } }
          },
          scales: {
            x: { stacked: true, ticks: { color: "#475569", autoSkip: false, maxRotation: 30 } },
            y: {
              stacked: true,
              beginAtZero: true,
              max: 100,
              grid: { color: "rgba(0,0,0,0.06)" },
              ticks: { color: "#475569", callback: v => `${v}%` }
            }
          }
        }
      });
    }

    function getTopSchoolsByStudents(map, topN = 4) {
      const list = Array.from(map.values())
        .map(d => ({ school: d.school, students: d.students || 0 }))
        .sort((a, b) => b.students - a.students)
        .slice(0, topN);
      return list;
    }

    function getTopSchoolsFromMerged(data, topN = 4) {
      return [...data]
        .sort((a, b) => (b.curr?.students || 0) - (a.curr?.students || 0))
        .slice(0, topN)
        .map(d => d.school);
    }

    function renderDistributionCharts(schools = null) {
      const currTop = getTopSchoolsByStudents(state.currAgg, 4);
      const prevTop = getTopSchoolsByStudents(state.prevAgg, 4);

      const currList = schools ? currTop.filter(d => schools.includes(d.school)) : currTop;
      const prevList = schools ? prevTop.filter(d => schools.includes(d.school)) : prevTop;

      const currLabels = currList.map(d => d.school);
      const currData = currList.map(d => d.students);
      const prevLabels = prevList.map(d => d.school);
      const prevData = prevList.map(d => d.students);

      const palette = ["#9CCEF4", "#B7E4C7", "#FFD6A5", "#E7C6FF"];
      const gridColor = "rgba(0,0,0,0.06)";
      const tickColor = "#475569";

      if (state.charts.distBarCurr) state.charts.distBarCurr.destroy();
      if (state.charts.distPieCurr) state.charts.distPieCurr.destroy();
      if (state.charts.distBarPrev) state.charts.distBarPrev.destroy();
      if (state.charts.distPiePrev) state.charts.distPiePrev.destroy();

      const barCurrCtx = $("distBarCurr").getContext("2d");
      state.charts.distBarCurr = new Chart(barCurrCtx, {
        type: "bar",
        data: {
          labels: currLabels,
          datasets: [{
            label: "Alumnos",
            data: currData,
            backgroundColor: palette,
            borderColor: ["#5FA8E4", "#7BCFA7", "#FFB570", "#C9A5F3"],
            borderWidth: 1,
            borderRadius: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => `${ctx.parsed.y} alumnos` } }
          },
          scales: {
            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: tickColor } },
            x: {
              ticks: {
                color: tickColor,
                autoSkip: false,
                maxRotation: 30,
                minRotation: 0,
                font: { size: 12 },
                padding: 6
              }
            }
          }
        }
      });

      const pieCurrCtx = $("distPieCurr").getContext("2d");
      state.charts.distPieCurr = new Chart(pieCurrCtx, {
        type: "doughnut",
        data: {
          labels: currLabels,
          datasets: [{ data: currData, backgroundColor: palette }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { bottom: 12 } },
          plugins: {
            legend: { position: "bottom", labels: { boxWidth: 14, font: { size: 12, weight: "500" } } },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const pct = total ? (ctx.parsed / total) * 100 : 0;
                  return `${pct.toFixed(1)}%`;
                }
              }
            }
          }
        }
      });

      const barPrevCtx = $("distBarPrev").getContext("2d");
      state.charts.distBarPrev = new Chart(barPrevCtx, {
        type: "bar",
        data: {
          labels: prevLabels,
          datasets: [{
            label: "Alumnos",
            data: prevData,
            backgroundColor: palette,
            borderColor: ["#5FA8E4", "#7BCFA7", "#FFB570", "#C9A5F3"],
            borderWidth: 1,
            borderRadius: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => `${ctx.parsed.y} alumnos` } }
          },
          scales: {
            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: tickColor } },
            x: {
              ticks: {
                color: tickColor,
                autoSkip: false,
                maxRotation: 30,
                minRotation: 0,
                font: { size: 12 },
                padding: 6
              }
            }
          }
        }
      });

      const piePrevCtx = $("distPiePrev").getContext("2d");
      state.charts.distPiePrev = new Chart(piePrevCtx, {
        type: "doughnut",
        data: {
          labels: prevLabels,
          datasets: [{ data: prevData, backgroundColor: palette }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { bottom: 12 } },
          plugins: {
            legend: { position: "bottom", labels: { boxWidth: 14, font: { size: 12, weight: "500" } } },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const pct = total ? (ctx.parsed / total) * 100 : 0;
                  return `${pct.toFixed(1)}%`;
                }
              }
            }
          }
        }
      });
    }

    // ============================
    // Filtros, orden y exportación
    // ============================
    function applyFilters() {
      const residual = valueOr("filterResidual", "all");
      const top4 = valueOr("filterTop4", "all");
      let data = [...state.merged];
      if (residual === "hide") data = data.filter(d => (d.curr?.students || 0) >= 5);
      const topSchools = getTopSchoolsFromMerged(data, 4);
      const visibleSchools = top4 === "top4" ? topSchools : null;

      renderDistributionTable(visibleSchools ? data.filter(d => visibleSchools.includes(d.school)) : data);
      return data;
    }

    function exportCSV(data) {
      const headers = ["Colegio", "Nº alumnos", "Media anterior", "Media actual", "Delta", "% cambio", "% suspensos"];
      const rows = data.map(d => [
        d.school,
        d.students,
        format(d.prevMean),
        format(d.currMean),
        format(d.delta),
        format(d.deltaPct, 1),
        format(d.failPct, 1)
      ]);
      const csv = [headers, ...rows].map(r => r.join(";"))
        .join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "analitica_colegios.csv";
      link.click();
    }

    function generateReport() {
      window.print();
    }

    // ============================
    // Orquestación principal
    // ============================
    async function processFiles() {
      const prevFile = $("filePrev").files[0];
      const currFile = $("fileCurr").files[0];
      if (!prevFile || !currFile) {
        $("status").textContent = "Cargue ambos archivos para continuar.";
        return;
      }
      $("status").textContent = "Procesando...";
      try {
        const [prevRaw, currRaw] = await Promise.all([readExcel(prevFile), readExcel(currFile)]);
        const prevClean = cleanRows(prevRaw, { excludeRepetidor: true });
        const currClean = cleanRows(currRaw, { excludeRepetidor: true });
        const prevAll = cleanRows(prevRaw, { excludeRepetidor: false });
        const currAll = cleanRows(currRaw, { excludeRepetidor: false });

        state.subjects = Array.from(new Set([...prevClean.subjects, ...currClean.subjects]));
        state.prevRows = prevClean.rows;
        state.currRows = currClean.rows;
        state.prevRowsAll = prevAll.rows;
        state.currRowsAll = currAll.rows;

        state.prevAgg = aggregateBySchool(state.prevRows, state.subjects);
        state.currAgg = aggregateBySchool(state.currRows, state.subjects);
        state.merged = mergeYearData(state.prevAgg, state.currAgg, state.subjects);
        state.failBins.prev = aggregateFailBins(state.prevRows, state.subjects);
        state.failBins.curr = aggregateFailBins(state.currRows, state.subjects);
        state.failBins.totalPrev = aggregateFailTotals(state.prevRowsAll, state.subjects);
        state.failBins.totalCurr = aggregateFailTotals(state.currRowsAll, state.subjects);

        const filtered = applyFilters();
        state.top4 = getTopSchoolsFromMerged(filtered, 4);
        const topSchools = valueOr("filterTop4", "all") === "top4" ? state.top4 : null;
        renderDistributionCharts(topSchools);
        renderFailTables(topSchools);
        renderFailCharts(topSchools);
        updateTop4Selectors();
        renderFailTotalCharts();
        renderFailSingleCharts(state.top4[0]);
        renderCenterTabs();
        $("status").textContent = `Listo: ${state.merged.length} colegios analizados.`;
      } catch (err) {
        console.error(err);
        $("status").textContent = "Error al procesar los archivos. Verifique el formato.";
      }
    }

    // ============================
    // Eventos
    // ============================
    tabsContainer.addEventListener("click", (e) => {
      const btn = e.target.closest(".tab-btn");
      if (!btn) return;
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
      btn.classList.add("active");
      $(`tab-${btn.dataset.tab}`).classList.add("active");
      if (btn.dataset.tab.startsWith("center-")) {
        document.body.classList.add("center-active");
      } else {
        document.body.classList.remove("center-active");
      }
    });

    $("btnProcess").addEventListener("click", processFiles);
    $("btnExportCSV").addEventListener("click", () => exportCSV(applyFilters()));
    $("btnReport").addEventListener("click", generateReport);
    $("filterResidual").addEventListener("change", applyFilters);
    $("filterTop4").addEventListener("change", () => {
      const filtered = applyFilters();
      state.top4 = getTopSchoolsFromMerged(filtered, 4);
      const topSchools = valueOr("filterTop4", "all") === "top4" ? state.top4 : null;
      renderDistributionCharts(topSchools);
      renderFailTables(topSchools);
      renderFailCharts(topSchools);
      updateTop4Selectors();
      renderFailSingleCharts(state.top4[0]);
    });

    $("failAbsSelect").addEventListener("change", (e) => {
      renderFailSingleCharts(e.target.value);
      $("failPctSelect").value = e.target.value;
    });
    $("failPctSelect").addEventListener("change", (e) => {
      renderFailSingleCharts(e.target.value);
      $("failAbsSelect").value = e.target.value;
    });

    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-export]");
      if (!btn) return;
      exportTabToPdf(btn.dataset.export);
    });
    // Los selectores eliminados no requieren eventos adicionales
  </script>
</body>
</html>
