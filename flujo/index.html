<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JefaturaFlow v1.0 "Maestría"</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* Estilos para el hack del selector de fecha nativo */
        .date-input-container {
            position: relative;
            overflow: hidden;
        }
        .native-date-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }
        .native-date-input::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            cursor: pointer;
            transform: scale(25);
        }

        /* Feedback visual para Drag & Drop */
        .dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        .drag-over-proc {
            border: 3px solid #6366f1 !important;
            background-color: #eef2ff !important;
        }
        .drag-over-task {
            border: 2px dashed #4f46e5 !important;
            background-color: #f5f3ff !important;
        }

        /* Scrollbars personalizadas */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        
        [contenteditable]:focus {
            outline: none;
            background: rgba(255,255,255,0.5);
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header / Panel de Control -->
    <header class="bg-white border-b border-slate-200 p-4 shadow-sm z-30">
        <div class="max-w-[1600px] mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-indigo-200 shadow-lg">
                    <i class="ph-bold ph-stack text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-800 leading-none">Jefatura<span class="text-indigo-600">Flow</span></h1>
                    <span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">v1.0 Maestría (Estable)</span>
                </div>
            </div>

            <div class="flex items-center gap-4 flex-1 justify-center">
                <!-- Creador de Procesos -->
                <div class="flex items-center bg-slate-100 p-1 rounded-xl border border-slate-200">
                    <input id="newProcessTitle" type="text" placeholder="Nuevo Proceso..." class="bg-transparent px-3 py-1 text-sm outline-none w-40">
                    <input id="newProcessColor" type="color" value="#6366f1" onchange="this.blur()" class="w-8 h-8 rounded-lg border-none cursor-pointer bg-transparent p-0">
                    <button onclick="addProcess()" class="ml-1 bg-white hover:bg-slate-50 text-slate-700 p-2 rounded-lg transition-colors border border-slate-200 shadow-sm">
                        <i class="ph ph-plus-circle"></i>
                    </button>
                </div>

                <!-- Creador de Tareas -->
                <div class="flex items-center bg-indigo-50 p-1 rounded-xl border border-indigo-100">
                    <input id="newTaskTitle" type="text" placeholder="Nueva Tarea..." class="bg-transparent px-3 py-1 text-sm outline-none w-48">
                    <button onclick="addTaskToInbox()" class="ml-1 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors shadow-md shadow-indigo-100">
                        Añadir Tarea
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <div class="flex bg-slate-100 p-1 rounded-xl mr-4">
                    <button id="btnTablero" onclick="setView('board')" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all bg-white shadow-sm text-indigo-600">Tablero</button>
                    <button id="btnCalendario" onclick="setView('calendar')" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-slate-500 hover:text-slate-700">Calendario</button>
                </div>
                <button onclick="exportData()" title="Exportar JSON" class="p-2 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors border border-slate-200">
                    <i class="ph-bold ph-export"></i>
                </button>
                <label title="Importar JSON" class="p-2 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors border border-slate-200 cursor-pointer">
                    <i class="ph-bold ph-export inline-block rotate-180"></i>
                    <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                </label>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar: Bandeja de Entrada -->
        <aside id="inbox" class="w-72 flex-shrink-0 bg-white border-r border-slate-200 flex flex-col z-20 transition-all duration-300">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                <h2 class="font-bold text-slate-700 flex items-center gap-2">
                    <i class="ph-fill ph-tray text-indigo-500"></i> Bandeja
                </h2>
                <span id="inboxCount" class="bg-slate-200 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
            </div>
            <div id="inboxTasks" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 custom-scrollbar" ondragover="handleDragOverTask(event)" ondrop="handleDropTask(event, 'inbox')">
                <!-- Tareas de bandeja aquí -->
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden flex flex-col">
            
            <!-- Vista Tablero (Cuadrícula 3xN) -->
            <div id="viewBoard" class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <div id="processContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-max">
                    <!-- Procesos dinámicos aquí -->
                </div>
            </div>

            <!-- Vista Calendario -->
            <div id="viewCalendar" class="hidden flex-1 flex flex-col p-6 overflow-hidden">
                <div class="flex items-center justify-between mb-4 bg-white p-3 rounded-2xl border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-4">
                        <button onclick="prevPeriod()" class="p-2 hover:bg-slate-100 rounded-lg"><i class="ph-bold ph-caret-left"></i></button>
                        <h2 id="calendarTitle" class="text-lg font-bold min-w-[150px] text-center">Enero 2024</h2>
                        <button onclick="nextPeriod()" class="p-2 hover:bg-slate-100 rounded-lg"><i class="ph-bold ph-caret-right"></i></button>
                    </div>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button onclick="setCalMode('month')" id="calMonth" class="px-4 py-1 rounded-lg text-sm font-medium bg-white shadow-sm transition-all">Mes</button>
                        <button onclick="setCalMode('quarter')" id="calQuarter" class="px-4 py-1 rounded-lg text-sm font-medium transition-all text-slate-500">Trimestre</button>
                        <button onclick="setCalMode('year')" id="calYear" class="px-4 py-1 rounded-lg text-sm font-medium transition-all text-slate-500">Año</button>
                    </div>
                    <button onclick="goToToday()" class="text-sm font-semibold text-indigo-600 hover:text-indigo-700 px-4">Ir a Hoy</button>
                </div>
                <div id="calendarGrid" class="flex-1 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-auto custom-scrollbar">
                    <!-- Rejilla de calendario dinámica -->
                </div>
            </div>

        </main>
    </div>

    <!-- Modal de Confirmación -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all">
            <div class="text-center">
                <div class="bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph-bold ph-warning text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">¿Confirmar eliminación?</h3>
                <p id="modalMessage" class="text-slate-500 text-sm mb-6">Esta acción no se puede deshacer.</p>
                <div class="flex gap-3">
                    <button onclick="closeModal()" class="flex-1 px-4 py-2 border border-slate-200 rounded-xl text-sm font-semibold hover:bg-slate-50">Cancelar</button>
                    <button id="modalConfirmBtn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-xl text-sm font-semibold hover:bg-red-700">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toasts -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 transform translate-y-20 transition-all duration-300 opacity-0 z-[110]">
        <i id="toastIcon" class="ph-bold ph-info"></i>
        <span id="toastMsg" class="text-sm font-medium"></span>
    </div>

    <script>
        // --- ESTADO INICIAL ---
        let appState = {
            view: 'board', 
            calMode: 'month', 
            currentDate: new Date(),
            processes: [
                { id: 'p1', title: 'Evaluación 1º Trimestre', color: '#6366f1', tasks: [] },
                { id: 'p2', title: 'Gestión de Faltas', color: '#10b981', tasks: [] },
                { id: 'p3', title: 'Exámenes Pendientes', color: '#f59e0b', tasks: [] }
            ],
            inbox: [
                { id: 't1', title: 'Revisar actas pendientes', responsible: 'Jefe Estudios', date: new Date().toISOString().split('T')[0], done: false }
            ]
        };

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        let draggingTaskId = null;
        let draggingProcId = null;

        // --- MANEJO DE VISTAS ---
        function setCalMode(mode) {
            appState.calMode = mode;
            renderCalendar();
        }

        function setView(view) {
            appState.view = view;
            const sidebar = document.getElementById('inbox');
            const viewBoard = document.getElementById('viewBoard');
            const viewCalendar = document.getElementById('viewCalendar');
            const btnTablero = document.getElementById('btnTablero');
            const btnCalendario = document.getElementById('btnCalendario');

            if (view === 'board') {
                sidebar.classList.remove('hidden');
                viewBoard.classList.remove('hidden');
                viewCalendar.classList.add('hidden');
                btnTablero.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                btnCalendario.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
            } else {
                sidebar.classList.add('hidden');
                viewBoard.classList.add('hidden');
                viewCalendar.classList.remove('hidden');
                btnCalendario.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                btnTablero.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
            }
            renderAll();
        }

        // --- CORE RENDER ---
        function renderAll() {
            renderSidebar();
            if (appState.view === 'board') renderBoard();
            else renderCalendar();
            saveToLocalStorage();
        }

        function renderSidebar() {
            const container = document.getElementById('inboxTasks');
            if (!container) return;
            document.getElementById('inboxCount').innerText = appState.inbox.length;
            container.innerHTML = '';
            appState.inbox.forEach(task => container.appendChild(createTaskElement(task, 'inbox')));
        }

        function renderBoard() {
            const container = document.getElementById('processContainer');
            if (!container) return;
            container.innerHTML = '';
            appState.processes.forEach(proc => {
                const procEl = document.createElement('div');
                procEl.draggable = true;
                procEl.className = `bg-slate-100 rounded-2xl border-2 border-slate-200 flex flex-col h-[400px] transition-all`;
                procEl.style.borderColor = proc.color;
                
                // Eventos de Drag para reordenar procesos
                procEl.addEventListener('dragstart', (e) => {
                    if (draggingTaskId) return;
                    draggingProcId = proc.id;
                    procEl.classList.add('dragging');
                    e.dataTransfer.setData('type', 'process');
                });
                
                procEl.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggingProcId && draggingProcId !== proc.id) procEl.classList.add('drag-over-proc');
                    if (draggingTaskId) procEl.classList.add('drag-over-task');
                });

                procEl.addEventListener('dragleave', () => procEl.classList.remove('drag-over-proc', 'drag-over-task'));

                procEl.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggingProcId && draggingProcId !== proc.id) handleProcDrop(draggingProcId, proc.id);
                    else if (draggingTaskId) handleDropTask(null, proc.id);
                    procEl.classList.remove('drag-over-proc', 'drag-over-task');
                });

                procEl.innerHTML = `
                    <div class="p-4 flex items-center justify-between border-b border-slate-200 bg-white rounded-t-2xl cursor-move">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${proc.color}"></div>
                            <h3 contenteditable="true" 
                                onmousedown="event.stopPropagation()"
                                onkeydown="if(event.key === 'Enter') { event.preventDefault(); this.blur(); }"
                                onblur="updateProcessTitle('${proc.id}', this.innerText)" 
                                class="font-bold text-slate-700 outline-none truncate block uppercase text-xs tracking-wide">${proc.title}</h3>
                        </div>
                        <button onclick="confirmDeleteProcess('${proc.id}')" class="text-slate-400 hover:text-red-500 transition-colors ml-2">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-3 flex flex-col gap-3 custom-scrollbar">
                        ${proc.tasks.map(task => `<div id="task-container-${task.id}"></div>`).join('')}
                    </div>
                `;
                
                container.appendChild(procEl);
                proc.tasks.forEach(task => {
                    const taskPlaceholder = procEl.querySelector(`#task-container-${task.id}`);
                    if(taskPlaceholder) taskPlaceholder.replaceWith(createTaskElement(task, proc.id));
                });
            });
        }

        function createTaskElement(task, locationId) {
            const el = document.createElement('div');
            el.draggable = true;
            el.id = `task-${task.id}`;
            const isOverdue = !task.done && task.date && new Date(task.date) < new Date().setHours(0,0,0,0);
            el.className = `bg-white p-3 rounded-xl border border-slate-200 shadow-sm transition-all cursor-grab active:cursor-grabbing hover:shadow-md ${task.done ? 'opacity-50' : ''}`;
            if (isOverdue) el.classList.add('border-red-500', 'bg-red-50');

            el.innerHTML = `
                <div class="flex items-start gap-2 mb-2">
                    <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTaskDone('${task.id}', '${locationId}')" class="mt-1.5 rounded text-indigo-600 cursor-pointer">
                    <div class="flex-1 min-w-0">
                        <div contenteditable="true" 
                             onmousedown="event.stopPropagation()" 
                             onkeydown="if(event.key === 'Enter') { event.preventDefault(); this.blur(); }" 
                             onblur="updateTaskTitle('${task.id}', '${locationId}', this.innerText)" 
                             class="text-sm font-bold text-slate-800 outline-none truncate block ${task.done ? 'line-through text-slate-500' : ''}">${task.title}</div>
                        <div class="text-[11px] font-semibold text-slate-500 flex items-center gap-1 uppercase tracking-wider outline-none mt-1">
                            <i class="ph ph-user"></i> 
                            <span contenteditable="true" 
                                  draggable="false" 
                                  onmousedown="event.stopPropagation()" 
                                  onkeydown="if(event.key === 'Enter') { event.preventDefault(); this.blur(); }" 
                                  onfocus="this.innerText = '';" 
                                  onblur="updateTaskResp('${task.id}', '${locationId}', this.innerText)" 
                                  class="flex-1 block truncate cursor-text min-w-[20px]">
                                ${task.responsible || 'Responsable...'}
                            </span>
                        </div>
                    </div>
                    <button onclick="confirmDeleteTask('${task.id}', '${locationId}')" class="text-slate-300 hover:text-red-500 ml-1 transition-colors"><i class="ph ph-x"></i></button>
                </div>
                <div class="flex items-center justify-between mt-3">
                    <div class="date-input-container">
                        <button class="flex items-center gap-1.5 text-[11px] font-bold ${isOverdue ? 'text-red-600' : 'text-slate-600'} bg-slate-50 px-2 py-1 rounded-md border border-slate-200">
                            <i class="ph ph-calendar"></i><span>${task.date ? formatDate(task.date) : 'Sin fecha'}</span>
                        </button>
                        <input type="date" value="${task.date}" class="native-date-input" onchange="updateTaskDate('${task.id}', '${locationId}', this.value)">
                    </div>
                </div>
            `;

            el.addEventListener('dragstart', (e) => {
                if (document.activeElement.getAttribute('contenteditable') === 'true') { e.preventDefault(); return; }
                draggingTaskId = task.id;
                el.classList.add('dragging');
                e.dataTransfer.setData('type', 'task');
                e.stopPropagation();
            });
            return el;
        }

        // --- CALENDARIO ---
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');
            if (!grid) return;
            grid.innerHTML = '';

            ['calMonth', 'calQuarter', 'calYear'].forEach(id => {
                const btn = document.getElementById(id);
                if (!btn) return;
                const isSelected = id === 'cal' + appState.calMode.charAt(0).toUpperCase() + appState.calMode.slice(1);
                if (isSelected) {
                    btn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                    btn.classList.remove('text-slate-500');
                } else {
                    btn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                    btn.classList.add('text-slate-500');
                }
            });

            const year = appState.currentDate.getFullYear();
            const month = appState.currentDate.getMonth();
            
            if (appState.calMode === 'month') {
                title.innerText = `${monthNames[month]} ${year}`;
                grid.appendChild(createMonthGrid(year, month));
            } else if (appState.calMode === 'quarter') {
                const startMonth = Math.floor(month / 3) * 3;
                title.innerText = `Trimestre: ${monthNames[startMonth]} - ${monthNames[startMonth+2]} ${year}`;
                const qContainer = document.createElement('div');
                qContainer.className = "grid grid-cols-1 lg:grid-cols-3 gap-6 p-4";
                for (let m = startMonth; m <= startMonth + 2; m++) qContainer.appendChild(createMonthWrapper(year, m));
                grid.appendChild(qContainer);
            } else {
                title.innerText = `Año ${year}`;
                const yContainer = document.createElement('div');
                yContainer.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6";
                for (let m = 0; m < 12; m++) yContainer.appendChild(createMonthWrapper(year, m));
                grid.appendChild(yContainer);
            }
        }

        function createMonthWrapper(year, m) {
            const wrap = document.createElement('div');
            wrap.className = "flex flex-col h-full bg-slate-50/50 rounded-xl border border-slate-100 p-2 shadow-sm";
            wrap.innerHTML = `<h3 class="font-bold text-slate-700 border-b border-slate-200 pb-2 mb-2 text-center text-xs uppercase tracking-wider">${monthNames[m]} ${year}</h3>`;
            wrap.appendChild(createMonthGrid(year, m, true)); 
            return wrap;
        }

        function createMonthGrid(year, month, isCompact = false) {
            const container = document.createElement('div');
            container.className = "w-full";
            const weekdays = ["Lu", "Ma", "Mi", "Ju", "Vi", "Sá", "Do"];
            const headerRow = document.createElement('div');
            headerRow.className = "grid grid-cols-7 border-b border-slate-100 bg-white/50";
            weekdays.forEach(d => headerRow.innerHTML += `<div class="p-2 text-center text-[9px] font-black text-slate-400 uppercase">${d}</div>`);
            container.appendChild(headerRow);

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let startOffset = firstDay.getDay() - 1;
            if (startOffset === -1) startOffset = 6;

            const daysContainer = document.createElement('div');
            daysContainer.className = `grid grid-cols-7 ${isCompact ? 'auto-rows-fr' : 'auto-rows-[minmax(100px,auto)]'}`;
            for (let i = 0; i < startOffset; i++) daysContainer.innerHTML += `<div class="p-1 border-r border-b border-slate-50 bg-slate-50/20 opacity-50"></div>`;

            const todayStr = new Date().toISOString().split('T')[0];
            const allTasks = getAllTasks();

            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const dayTasks = allTasks.filter(t => t.date === dateStr);
                const dayEl = document.createElement('div');
                dayEl.className = `p-1 border-r border-b border-slate-100 flex flex-col gap-1 min-h-[40px] ${isToday ? 'bg-indigo-50/30' : 'bg-white'}`;
                dayEl.innerHTML = `<div class="text-right"><span class="text-[9px] font-bold ${isToday ? 'bg-indigo-600 text-white px-1 rounded shadow-sm' : 'text-slate-400'}">${d}</span></div>`;
                dayTasks.forEach(task => {
                    const tEl = document.createElement('div');
                    const isOverdue = !task.done && task.date < todayStr;
                    tEl.className = `text-[8px] px-1 py-0.5 rounded border truncate ${task.done ? 'bg-slate-100 text-slate-400 line-through' : (isOverdue ? 'bg-red-100 border-red-200 text-red-700 font-bold' : 'bg-indigo-100 border-indigo-200 text-indigo-700 font-medium')}`;
                    tEl.innerText = task.title;
                    dayEl.appendChild(tEl);
                });
                daysContainer.appendChild(dayEl);
            }
            container.appendChild(daysContainer);
            return container;
        }

        // --- NAVEGACIÓN PERIODO ---
        function nextPeriod() {
            if (appState.calMode === 'month') appState.currentDate.setMonth(appState.currentDate.getMonth() + 1);
            else if (appState.calMode === 'quarter') appState.currentDate.setMonth(appState.currentDate.getMonth() + 3);
            else appState.currentDate.setFullYear(appState.currentDate.getFullYear() + 1);
            renderCalendar();
        }

        function prevPeriod() {
            if (appState.calMode === 'month') appState.currentDate.setMonth(appState.currentDate.getMonth() - 1);
            else if (appState.calMode === 'quarter') appState.currentDate.setMonth(appState.currentDate.getMonth() - 3);
            else appState.currentDate.setFullYear(appState.currentDate.getFullYear() - 1);
            renderCalendar();
        }

        function goToToday() {
            appState.currentDate = new Date();
            renderCalendar();
        }

        // --- DATA HANDLERS ---
        function addProcess() {
            const titleInput = document.getElementById('newProcessTitle');
            if (!titleInput.value) return showToast('Escribe un título');
            appState.processes.push({ id: 'p-' + Date.now(), title: titleInput.value, color: document.getElementById('newProcessColor').value, tasks: [] });
            titleInput.value = '';
            renderAll();
            showToast('Proceso añadido');
        }

        function addTaskToInbox() {
            const input = document.getElementById('newTaskTitle');
            if (!input.value) return showToast('Escribe un título');
            appState.inbox.unshift({ id: 't-' + Date.now(), title: input.value, responsible: '', date: new Date().toISOString().split('T')[0], done: false });
            input.value = '';
            renderAll();
            showToast('Tarea añadida');
        }

        function updateProcessTitle(id, val) { const p = appState.processes.find(x => x.id === id); if(p) p.title = val; saveToLocalStorage(); }
        function updateTaskTitle(id, loc, val) { const t = findTask(id, loc); if(t && t.task) t.task.title = val; saveToLocalStorage(); }
        function updateTaskResp(id, loc, val) { const t = findTask(id, loc); if(t && t.task) { t.task.responsible = (val.trim()===''||val.trim()==='Responsable...') ? '' : val.trim(); } renderAll(); }
        function updateTaskDate(id, loc, val) { const t = findTask(id, loc); if(t && t.task) t.task.date = val; renderAll(); }
        function toggleTaskDone(id, loc) { const t = findTask(id, loc); if(t && t.task) t.task.done = !t.task.done; renderAll(); }
        
        function handleProcDrop(s, t) {
            const from = appState.processes.findIndex(p => p.id === s), to = appState.processes.findIndex(p => p.id === t);
            if (from!==-1 && to!==-1) { const [m] = appState.processes.splice(from, 1); appState.processes.splice(to, 0, m); renderAll(); }
        }

        function handleDropTask(e, target) {
            if (e) e.preventDefault();
            const id = draggingTaskId; if (!id) return;
            let task = null;
            const inIdx = appState.inbox.findIndex(x => x.id === id);
            if (inIdx!==-1) task = appState.inbox.splice(inIdx, 1)[0];
            else appState.processes.forEach(p => { const idx = p.tasks.findIndex(x => x.id === id); if (idx!==-1) task = p.tasks.splice(idx, 1)[0]; });
            if (!task) return;
            if (target === 'inbox') appState.inbox.push(task);
            else { const p = appState.processes.find(x => x.id === target); if(p) p.tasks.push(task); }
            renderAll();
        }

        function handleDragOverTask(e) { e.preventDefault(); if (draggingTaskId) { const dz = e.target.closest('[ondrop]'); if (dz) dz.classList.add('drag-over-task'); } }

        function findTask(id, loc) {
            if (loc === 'inbox') return { list: appState.inbox, task: appState.inbox.find(x => x.id === id) };
            const p = appState.processes.find(x => x.id === loc);
            return p ? { list: p.tasks, task: p.tasks.find(x => x.id === id) } : null;
        }

        function confirmDeleteProcess(id) { openModal('¿Eliminar proceso y sus tareas?', () => { appState.processes = appState.processes.filter(x => x.id !== id); renderAll(); closeModal(); showToast('Proceso eliminado'); }); }
        function confirmDeleteTask(id, loc) { openModal('¿Eliminar tarea?', () => { if(loc==='inbox') appState.inbox=appState.inbox.filter(x=>x.id!==id); else { const p=appState.processes.find(x=>x.id===loc); if(p) p.tasks=p.tasks.filter(x=>x.id!==id); } renderAll(); closeModal(); showToast('Tarea eliminada'); }); }

        function getAllTasks() { let t = [...appState.inbox]; appState.processes.forEach(p => t = t.concat(p.tasks)); return t; }
        function formatDate(s) { const [y,m,d] = s.split('-'); return `${d}/${m}/${y}`; }
        function showToast(m) { const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = m; t.classList.replace('translate-y-20', 'translate-y-0'); t.classList.replace('opacity-0', 'opacity-100'); setTimeout(() => { t.classList.replace('translate-y-0', 'translate-y-20'); t.classList.replace('opacity-100', 'opacity-0'); }, 3000); }
        function openModal(m, f) { document.getElementById('modalMessage').innerText = m; document.getElementById('modalConfirmBtn').onclick = f; document.getElementById('modalOverlay').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modalOverlay').classList.add('hidden'); }
        
        function saveToLocalStorage() { localStorage.setItem('jefaturaFlowData', JSON.stringify(appState)); }
        
        function loadFromLocalStorage() { 
            const s = localStorage.getItem('jefaturaFlowData'); 
            if (s) { 
                try { 
                    appState = JSON.parse(s); 
                    // Asegurar que currentDate sea un objeto Date
                    if (appState.currentDate) {
                        appState.currentDate = new Date(appState.currentDate);
                        if (isNaN(appState.currentDate.getTime())) appState.currentDate = new Date();
                    } else {
                        appState.currentDate = new Date();
                    }
                } catch(e) {
                    appState.currentDate = new Date();
                } 
            } 
        }

        function exportData() { const b = new Blob([JSON.stringify(appState, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `JefaturaFlow_Stable_${new Date().toISOString().split('T')[0]}.json`; a.click(); }
        
        function importData(e) { 
            const f = e.target.files[0]; 
            if (!f) return; 
            const r = new FileReader(); 
            r.onload = (ev) => { 
                try { 
                    appState = JSON.parse(ev.target.result); 
                    // Asegurar que currentDate sea un objeto Date tras la importación
                    if (appState.currentDate) {
                        appState.currentDate = new Date(appState.currentDate);
                        if (isNaN(appState.currentDate.getTime())) appState.currentDate = new Date();
                    } else {
                        appState.currentDate = new Date();
                    }
                    renderAll(); 
                    showToast('Datos Importados'); 
                } catch (err) { 
                    showToast('Error al importar'); 
                } 
            }; 
            r.readAsText(f); 
        }

        function setupGlobalEvents() {
            document.addEventListener('dragend', () => {
                document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                document.querySelectorAll('.drag-over-proc, .drag-over-task').forEach(el => el.classList.remove('drag-over-proc', 'drag-over-task'));
                draggingTaskId = null; draggingProcId = null;
            });
        }

        window.onload = () => { loadFromLocalStorage(); renderAll(); setupGlobalEvents(); };
    </script>
</body>
</html>
