<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JefaturaFlow - Gestión de Estudios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* Estilos para el hack del selector de fecha nativo */
        .date-input-container {
            position: relative;
            overflow: hidden;
        }
        .native-date-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }
        /* Expandir el área del click del calendario nativo en Webkit */
        .native-date-input::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            cursor: pointer;
            transform: scale(25);
        }

        /* Estilos para Drag & Drop */
        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .drag-over {
            border: 2px dashed #4f46e5 !important;
            background-color: #f5f3ff !important;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        
        [contenteditable]:focus {
            outline: none;
            background: rgba(255,255,255,0.5);
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header / Panel de Control -->
    <header class="bg-white border-b border-slate-200 p-4 shadow-sm z-30">
        <div class="max-w-[1600px] mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-indigo-200 shadow-lg">
                    <i class="ph-bold ph-stack text-white text-xl"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">Jefatura<span class="text-indigo-600">Flow</span></h1>
            </div>

            <div class="flex items-center gap-4 flex-1 justify-center">
                <!-- Creador de Procesos -->
                <div class="flex items-center bg-slate-100 p-1 rounded-xl border border-slate-200">
                    <input id="newProcessTitle" type="text" placeholder="Nuevo Proceso..." class="bg-transparent px-3 py-1 text-sm outline-none w-40">
                    <input id="newProcessColor" type="color" value="#6366f1" class="w-8 h-8 rounded-lg border-none cursor-pointer bg-transparent p-0">
                    <button onclick="addProcess()" class="ml-1 bg-white hover:bg-slate-50 text-slate-700 p-2 rounded-lg transition-colors border border-slate-200 shadow-sm">
                        <i class="ph ph-plus-circle"></i>
                    </button>
                </div>

                <!-- Creador de Tareas -->
                <div class="flex items-center bg-indigo-50 p-1 rounded-xl border border-indigo-100">
                    <input id="newTaskTitle" type="text" placeholder="Nueva Tarea..." class="bg-transparent px-3 py-1 text-sm outline-none w-48">
                    <button onclick="addTaskToInbox()" class="ml-1 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors shadow-md shadow-indigo-100">
                        Añadir Tarea
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <div class="flex bg-slate-100 p-1 rounded-xl mr-4">
                    <button id="btnTablero" onclick="setView('board')" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all bg-white shadow-sm text-indigo-600">Tablero</button>
                    <button id="btnCalendario" onclick="setView('calendar')" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-slate-500 hover:text-slate-700">Calendario</button>
                </div>
                <button onclick="exportData()" title="Exportar JSON" class="p-2 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors border border-slate-200">
                    <i class="ph-bold ph-export"></i>
                </button>
                <label class="p-2 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors border border-slate-200 cursor-pointer">
                    <i class="ph-bold ph-import"></i>
                    <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                </label>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar: Bandeja de Entrada -->
        <aside id="inbox" class="w-72 bg-white border-r border-slate-200 flex flex-col z-20 transition-all duration-300">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                <h2 class="font-bold text-slate-700 flex items-center gap-2">
                    <i class="ph-fill ph-tray text-indigo-500"></i> Bandeja
                </h2>
                <span id="inboxCount" class="bg-slate-200 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
            </div>
            <div id="inboxTasks" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 custom-scrollbar" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'inbox')">
                <!-- Tareas del inbox aquí -->
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden flex flex-col">
            
            <!-- Vista Tablero -->
            <div id="viewBoard" class="flex-1 overflow-x-auto p-6 custom-scrollbar">
                <div id="processContainer" class="flex gap-6 items-start h-full">
                    <!-- Procesos dinámicos aquí -->
                </div>
            </div>

            <!-- Vista Calendario -->
            <div id="viewCalendar" class="hidden flex-1 flex flex-col p-6 overflow-hidden">
                <div class="flex items-center justify-between mb-4 bg-white p-3 rounded-2xl border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-4">
                        <button onclick="prevPeriod()" class="p-2 hover:bg-slate-100 rounded-lg"><i class="ph-bold ph-caret-left"></i></button>
                        <h2 id="calendarTitle" class="text-lg font-bold min-w-[150px] text-center">Enero 2024</h2>
                        <button onclick="nextPeriod()" class="p-2 hover:bg-slate-100 rounded-lg"><i class="ph-bold ph-caret-right"></i></button>
                    </div>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button onclick="setCalMode('month')" id="calMonth" class="px-4 py-1 rounded-lg text-sm font-medium bg-white shadow-sm transition-all">Mes</button>
                        <button onclick="setCalMode('quarter')" id="calQuarter" class="px-4 py-1 rounded-lg text-sm font-medium transition-all text-slate-500">Trimestre</button>
                    </div>
                    <button onclick="goToToday()" class="text-sm font-semibold text-indigo-600 hover:text-indigo-700 px-4">Ir a Hoy</button>
                </div>
                <div id="calendarGrid" class="flex-1 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-auto custom-scrollbar">
                    <!-- Rejilla de calendario dinámica -->
                </div>
            </div>

        </main>
    </div>

    <!-- Modales y Notificaciones -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all">
            <div class="text-center">
                <div class="bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph-bold ph-warning text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">¿Confirmar eliminación?</h3>
                <p id="modalMessage" class="text-slate-500 text-sm mb-6">Esta acción no se puede deshacer.</p>
                <div class="flex gap-3">
                    <button onclick="closeModal()" class="flex-1 px-4 py-2 border border-slate-200 rounded-xl text-sm font-semibold hover:bg-slate-50">Cancelar</button>
                    <button id="modalConfirmBtn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-xl text-sm font-semibold hover:bg-red-700">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 transform translate-y-20 transition-all duration-300 opacity-0 z-[110]">
        <i id="toastIcon" class="ph-bold ph-info"></i>
        <span id="toastMsg" class="text-sm font-medium"></span>
    </div>

    <script>
        // --- ESTADO DE LA APLICACIÓN ---
        let appState = {
            view: 'board', // board | calendar
            calMode: 'month', // month | quarter
            currentDate: new Date(),
            processes: [
                { id: 'p1', title: 'Evaluación 1º Trimestre', color: '#6366f1', tasks: [] },
                { id: 'p2', title: 'Gestión de Faltas', color: '#10b981', tasks: [] }
            ],
            inbox: [
                { id: 't1', title: 'Revisar actas pendientes', responsible: 'Jefe Estudios', date: '2024-11-20', done: false }
            ]
        };

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            loadFromLocalStorage();
            renderAll();
            setupGlobalEvents();
        };

        function setupGlobalEvents() {
            document.addEventListener('dragend', () => {
                document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            });
        }

        // --- RENDERIZADO ---
        function renderAll() {
            renderSidebar();
            if (appState.view === 'board') {
                renderBoard();
            } else {
                renderCalendar();
            }
            saveToLocalStorage();
        }

        function renderSidebar() {
            const container = document.getElementById('inboxTasks');
            document.getElementById('inboxCount').innerText = appState.inbox.length;
            container.innerHTML = '';
            appState.inbox.forEach(task => {
                container.appendChild(createTaskElement(task, 'inbox'));
            });
        }

        function renderBoard() {
            const container = document.getElementById('processContainer');
            container.innerHTML = '';
            appState.processes.forEach(proc => {
                const procEl = document.createElement('div');
                procEl.className = `flex-shrink-0 w-80 bg-slate-100 rounded-2xl border-2 border-slate-200 flex flex-col max-h-full`;
                procEl.style.borderColor = proc.color;
                procEl.setAttribute('ondragover', 'handleDragOver(event)');
                procEl.setAttribute('ondrop', `handleDrop(event, '${proc.id}')`);

                procEl.innerHTML = `
                    <div class="p-4 flex items-center justify-between border-b border-slate-200 bg-white rounded-t-2xl">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${proc.color}"></div>
                            <h3 contenteditable="true" onblur="updateProcessTitle('${proc.id}', this.innerText)" class="font-bold text-slate-700 outline-none">${proc.title}</h3>
                        </div>
                        <button onclick="confirmDeleteProcess('${proc.id}')" class="text-slate-400 hover:text-red-500 transition-colors">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-3 flex flex-col gap-3 custom-scrollbar">
                        ${proc.tasks.map(task => `<div id="task-container-${task.id}"></div>`).join('')}
                    </div>
                `;
                
                container.appendChild(procEl);
                proc.tasks.forEach(task => {
                    const taskPlaceholder = procEl.querySelector(`#task-container-${task.id}`);
                    if(taskPlaceholder) taskPlaceholder.replaceWith(createTaskElement(task, proc.id));
                });
            });
        }

        function createTaskElement(task, locationId) {
            const el = document.createElement('div');
            el.draggable = true;
            el.id = `task-${task.id}`;
            const isOverdue = !task.done && task.date && new Date(task.date) < new Date().setHours(0,0,0,0);
            
            el.className = `bg-white p-3 rounded-xl border border-slate-200 shadow-sm transition-all cursor-grab active:cursor-grabbing hover:shadow-md ${task.done ? 'opacity-50' : ''}`;
            if (isOverdue) el.classList.add('border-red-500', 'bg-red-50');

            const formattedDate = task.date ? formatDate(task.date) : 'Sin fecha';

            el.innerHTML = `
                <div class="flex items-start gap-2 mb-2">
                    <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTaskDone('${task.id}', '${locationId}')" class="mt-1.5 rounded text-indigo-600 focus:ring-indigo-500">
                    <div class="flex-1 min-w-0">
                        <div contenteditable="true" onblur="updateTaskTitle('${task.id}', '${locationId}', this.innerText)" class="text-sm font-bold text-slate-800 outline-none truncate block ${task.done ? 'line-through text-slate-500' : ''}">${task.title}</div>
                        <div contenteditable="true" onblur="updateTaskResp('${task.id}', '${locationId}', this.innerText)" class="text-[11px] font-semibold text-slate-500 flex items-center gap-1 uppercase tracking-wider outline-none">
                            <i class="ph ph-user"></i> ${task.responsible || 'Responsable...'}
                        </div>
                    </div>
                    <button onclick="confirmDeleteTask('${task.id}', '${locationId}')" class="text-slate-300 hover:text-red-500">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="flex items-center justify-between mt-3">
                    <div class="date-input-container">
                        <button class="flex items-center gap-1.5 text-[11px] font-bold ${isOverdue ? 'text-red-600' : 'text-slate-600'} bg-slate-50 px-2 py-1 rounded-md border border-slate-200">
                            <i class="ph ph-calendar"></i>
                            <span>${formattedDate}</span>
                        </button>
                        <input type="date" value="${task.date}" class="native-date-input" onchange="updateTaskDate('${task.id}', '${locationId}', this.value)">
                    </div>
                    <div class="text-[9px] font-black text-slate-300">ID: ${task.id.split('-')[0]}</div>
                </div>
            `;

            el.addEventListener('dragstart', (e) => {
                el.classList.add('dragging');
                e.dataTransfer.setData('text/plain', task.id);
            });

            return el;
        }

        // --- GESTIÓN DE PROCESOS ---
        function addProcess() {
            const titleInput = document.getElementById('newProcessTitle');
            const colorInput = document.getElementById('newProcessColor');
            if (!titleInput.value) return showToast('Introduce un título para el proceso');

            appState.processes.push({
                id: 'p-' + Date.now(),
                title: titleInput.value,
                color: colorInput.value,
                tasks: []
            });

            titleInput.value = '';
            renderAll();
            showToast('Proceso creado correctamente');
        }

        function updateProcessTitle(id, newTitle) {
            const proc = appState.processes.find(p => p.id === id);
            if (proc) proc.title = newTitle;
            saveToLocalStorage();
        }

        function confirmDeleteProcess(id) {
            const proc = appState.processes.find(p => p.id === id);
            openModal(`¿Eliminar el proceso "${proc.title}" y todas sus tareas?`, () => {
                appState.processes = appState.processes.filter(p => p.id !== id);
                renderAll();
                showToast('Proceso eliminado');
                closeModal();
            });
        }

        // --- GESTIÓN DE TAREAS ---
        function addTaskToInbox() {
            const input = document.getElementById('newTaskTitle');
            if (!input.value) return showToast('Escribe un título para la tarea');

            appState.inbox.unshift({
                id: 't-' + Date.now(),
                title: input.value,
                responsible: '',
                date: new Date().toISOString().split('T')[0],
                done: false
            });

            input.value = '';
            renderAll();
        }

        function updateTaskTitle(taskId, locId, val) {
            const t = findTask(taskId, locId);
            if(t && t.task) t.task.title = val;
            saveToLocalStorage();
        }

        function updateTaskResp(taskId, locId, val) {
            const t = findTask(taskId, locId);
            if(t && t.task) t.task.responsible = val;
            saveToLocalStorage();
        }

        function updateTaskDate(taskId, locId, val) {
            const t = findTask(taskId, locId);
            if(t && t.task) t.task.date = val;
            renderAll();
        }

        function toggleTaskDone(taskId, locId) {
            const t = findTask(taskId, locId);
            if(t && t.task) t.task.done = !t.task.done;
            renderAll();
        }

        function findTask(taskId, locId) {
            if (locId === 'inbox') {
                return { list: appState.inbox, task: appState.inbox.find(t => t.id === taskId) };
            }
            const proc = appState.processes.find(p => p.id === locId);
            if(!proc) return null;
            return { list: proc.tasks, task: proc.tasks.find(t => t.id === taskId) };
        }

        function confirmDeleteTask(taskId, locId) {
            openModal('¿Eliminar esta tarea definitivamente?', () => {
                if (locId === 'inbox') {
                    appState.inbox = appState.inbox.filter(t => t.id !== taskId);
                } else {
                    const proc = appState.processes.find(p => p.id === locId);
                    if(proc) proc.tasks = proc.tasks.filter(t => t.id !== taskId);
                }
                renderAll();
                closeModal();
            });
        }

        // --- DRAG & DROP LOGIC ---
        function handleDragOver(e) {
            e.preventDefault();
            const dropzone = e.target.closest('[ondrop]');
            if (dropzone) dropzone.classList.add('drag-over');
        }

        function handleDrop(e, targetLocId) {
            e.preventDefault();
            const taskId = e.dataTransfer.getData('text/plain');
            
            let taskObj = null;

            const inboxIdx = appState.inbox.findIndex(t => t.id === taskId);
            if (inboxIdx !== -1) {
                taskObj = appState.inbox.splice(inboxIdx, 1)[0];
            } else {
                appState.processes.forEach(p => {
                    const idx = p.tasks.findIndex(t => t.id === taskId);
                    if (idx !== -1) taskObj = p.tasks.splice(idx, 1)[0];
                });
            }

            if (!taskObj) return;

            if (targetLocId === 'inbox') {
                appState.inbox.push(taskObj);
            } else {
                const targetProc = appState.processes.find(p => p.id === targetLocId);
                if(targetProc) targetProc.tasks.push(taskObj);
            }

            renderAll();
        }

        // --- CALENDARIO ---
        function setCalMode(mode) {
            appState.calMode = mode;
            const mBtn = document.getElementById('calMonth');
            const qBtn = document.getElementById('calQuarter');
            
            if (mode === 'month') {
                mBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                mBtn.classList.remove('text-slate-500');
                qBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                qBtn.classList.add('text-slate-500');
            } else {
                qBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                qBtn.classList.remove('text-slate-500');
                mBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                mBtn.classList.add('text-slate-500');
            }
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');
            grid.innerHTML = '';

            const date = appState.currentDate;
            const year = date.getFullYear();
            const month = date.getMonth();
            
            if (appState.calMode === 'month') {
                title.innerText = `${monthNames[month]} ${year}`;
                grid.appendChild(createMonthGrid(year, month));
            } else {
                // Quarterly view: Show the trimester containing the current month
                const startMonth = Math.floor(month / 3) * 3;
                const endMonth = startMonth + 2;
                title.innerText = `${monthNames[startMonth]} - ${monthNames[endMonth]} ${year}`;
                
                const qContainer = document.createElement('div');
                qContainer.className = "flex flex-col gap-8 p-4";
                for (let m = startMonth; m <= endMonth; m++) {
                    const monthTitle = document.createElement('h3');
                    monthTitle.className = "font-bold text-slate-700 border-b pb-2 mb-2";
                    monthTitle.innerText = `${monthNames[m]} ${year}`;
                    qContainer.appendChild(monthTitle);
                    qContainer.appendChild(createMonthGrid(year, m));
                }
                grid.appendChild(qContainer);
            }
        }

        function createMonthGrid(year, month) {
            const container = document.createElement('div');
            container.className = "w-full mb-4";

            const weekdays = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
            const headerRow = document.createElement('div');
            headerRow.className = "grid grid-cols-7 border-b border-slate-100 bg-slate-50/50";
            weekdays.forEach(d => {
                headerRow.innerHTML += `<div class="p-3 text-center text-xs font-black text-slate-400 uppercase tracking-widest">${d}</div>`;
            });
            container.appendChild(headerRow);

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let startOffset = firstDay.getDay() - 1;
            if (startOffset === -1) startOffset = 6;

            const daysContainer = document.createElement('div');
            daysContainer.className = "grid grid-cols-7 auto-rows-[minmax(100px,auto)]";
            
            for (let i = 0; i < startOffset; i++) {
                daysContainer.innerHTML += `<div class="p-2 border-r border-b border-slate-50 bg-slate-50/20 opacity-50"></div>`;
            }

            const todayStr = new Date().toISOString().split('T')[0];
            const allTasks = getAllTasks();

            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const dayTasks = allTasks.filter(t => t.date === dateStr);

                const dayEl = document.createElement('div');
                dayEl.className = `p-2 border-r border-b border-slate-100 flex flex-col gap-1 ${isToday ? 'bg-indigo-50/30' : ''}`;
                
                dayEl.innerHTML = `
                    <div class="text-right mb-1">
                        <span class="text-xs font-bold ${isToday ? 'bg-indigo-600 text-white px-1.5 py-0.5 rounded-full shadow-sm' : 'text-slate-400'}">${d}</span>
                    </div>
                `;

                dayTasks.forEach(task => {
                    const taskEl = document.createElement('div');
                    const isOverdue = !task.done && task.date < todayStr;
                    taskEl.className = `text-[10px] px-1.5 py-0.5 rounded border leading-tight truncate mb-1 ${task.done ? 'bg-slate-100 text-slate-400 line-through' : (isOverdue ? 'bg-red-100 border-red-200 text-red-700 font-bold' : 'bg-indigo-100 border-indigo-200 text-indigo-700 font-medium')}`;
                    taskEl.innerText = task.title;
                    dayEl.appendChild(taskEl);
                });

                daysContainer.appendChild(dayEl);
            }
            container.appendChild(daysContainer);
            return container;
        }

        function setView(view) {
            appState.view = view;
            const bBtn = document.getElementById('btnTablero');
            const cBtn = document.getElementById('btnCalendario');
            const bView = document.getElementById('viewBoard');
            const cView = document.getElementById('viewCalendar');

            if (view === 'board') {
                bBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                bBtn.classList.remove('text-slate-500');
                cBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                cBtn.classList.add('text-slate-500');
                bView.classList.remove('hidden');
                cView.classList.add('hidden');
            } else {
                cBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                cBtn.classList.remove('text-slate-500');
                bBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                bBtn.classList.add('text-slate-500');
                cView.classList.remove('hidden');
                bView.classList.add('hidden');
            }
            renderAll();
        }

        function nextPeriod() {
            if (appState.calMode === 'month') {
                appState.currentDate.setMonth(appState.currentDate.getMonth() + 1);
            } else {
                appState.currentDate.setMonth(appState.currentDate.getMonth() + 3);
            }
            renderCalendar();
        }

        function prevPeriod() {
            if (appState.calMode === 'month') {
                appState.currentDate.setMonth(appState.currentDate.getMonth() - 1);
            } else {
                appState.currentDate.setMonth(appState.currentDate.getMonth() - 3);
            }
            renderCalendar();
        }

        function goToToday() {
            appState.currentDate = new Date();
            renderCalendar();
        }
        function getAllTasks() {
            let tasks = [...appState.inbox];
            appState.processes.forEach(p => tasks = tasks.concat(p.tasks));
            return tasks;
        }

        // --- UTILS & DATA ---
        function formatDate(str) {
            const [y, m, d] = str.split('-');
            return `${d}/${m}/${y}`;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        }

        function openModal(msg, onConfirm) {
            const overlay = document.getElementById('modalOverlay');
            document.getElementById('modalMessage').innerText = msg;
            document.getElementById('modalConfirmBtn').onclick = onConfirm;
            overlay.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function exportData() {
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `JefaturaFlow_Export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('Datos exportados correctamente');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    appState = data;
                    renderAll();
                    showToast('Datos importados con éxito');
                } catch (err) {
                    showToast('Error al importar archivo');
                }
            };
            reader.readAsText(file);
        }

        function saveToLocalStorage() {
            localStorage.setItem('jefaturaFlowData', JSON.stringify(appState));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('jefaturaFlowData');
            if (saved) {
                appState = JSON.parse(saved);
                appState.currentDate = new Date();
            }
        }
    </script>
</body>
</html>
